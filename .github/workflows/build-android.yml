name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      - name: Install Dependencies
        run: |
          npm install --legacy-peer-deps
          npm install @capacitor/assets --save-dev --legacy-peer-deps
          npm install @capacitor/app-launcher --save --legacy-peer-deps

      # =========================================================
      # 3. Ø§Ù„Ø­Ù„ Ø§Ù„Ø´Ø§Ù…Ù„: ÙƒÙˆØ¯ ØªØ´Ø®ÙŠØµÙŠ Ø°ÙƒÙŠ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ HLS ÙˆØ§Ù„Ø±ÙˆØ§Ø¨Ø·
      # =========================================================
      - name: Inject Debug Player Logic
        run: |
          # 1. ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† Ù…Ø¬Ù„Ø¯ assets
          ASSETS_DIR=$(find . -type d -name "assets" | head -n 1)
          if [ -z "$ASSETS_DIR" ]; then
            mkdir -p www/assets
            ASSETS_DIR="www/assets"
          fi
          
          # 2. ÙƒØªØ§Ø¨Ø© ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªØ´Ø®ÙŠØµÙŠØ©)
          cat << 'EOF' > "$ASSETS_DIR/player_fix.js"
          
          console.log("ğŸ”§ Debug Player Script Loaded");

          document.addEventListener("DOMContentLoaded", () => {
              // Ù…Ø­Ø§ÙˆÙ„Ø© Ù…ØªÙƒØ±Ø±Ø© Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
              const checkBtnInterval = setInterval(() => {
                  const btn = document.getElementById('btn-open-external');
                  if (btn) {
                      clearInterval(checkBtnInterval);
                      initExternalPlayerFix(btn);
                  }
              }, 1000);
          });

          function initExternalPlayerFix(btn) {
              console.log("âœ… Button found, applying fix...");
              
              // 1. Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ø²Ø± (Ù„Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ ÙƒÙˆØ¯ Ù‚Ø¯ÙŠÙ…)
              const newBtn = btn.cloneNode(true);
              btn.parentNode.replaceChild(newBtn, btn);

              // 2. Ù…Ø¤Ø´Ø± Ø¨ØµØ±ÙŠ: Ø¥Ø·Ø§Ø± Ø£Ø­Ù…Ø± ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„
              newBtn.style.border = "2px solid red"; 
              newBtn.style.boxShadow = "0 0 10px red";

              newBtn.addEventListener('click', async (e) => {
                  e.preventDefault();
                  e.stopPropagation();

                  // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¶ØºØ·
                  // alert("ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±.. Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø·");

                  let finalUrl = null;

                  // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 1: Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… (Ø§Ù„Ø£Ø¶Ù…Ù† Ù…Ø¹ HLS)
                  if (typeof currentStreamInfo !== 'undefined' && currentStreamInfo && currentStreamInfo.url) {
                      finalUrl = currentStreamInfo.url;
                  } 
                  // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 2: Ù…Ù† window
                  else if (window.currentStreamInfo && window.currentStreamInfo.url) {
                      finalUrl = window.currentStreamInfo.url;
                  }
                  // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© 3: Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù€ blob)
                  else {
                      const v = document.getElementById('videoPlayer');
                      if (v && v.src && !v.src.startsWith('blob:')) {
                          finalUrl = v.src;
                      }
                  }

                  if (!finalUrl) {
                      alert("âš ï¸ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­.\n(Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø´ÙØ±Ø§Ù‹ blob ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„Ù‡ Ø®Ø§Ø±Ø¬ÙŠØ§Ù‹)");
                      return;
                  }

                  // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø§Ø¨Ø·
                  finalUrl = finalUrl.trim();
                  
                  // alert("Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬:\n" + finalUrl); // Ù„Ù„ØªØ¬Ø±Ø¨Ø©

                  // 3. Ø¨Ù†Ø§Ø¡ Intent
                  const scheme = finalUrl.startsWith('https') ? 'https' : 'http';
                  const cleanUrl = finalUrl.replace(scheme + '://', '');
                  
                  // Ø§Ø³ØªØ®Ø¯Ø§Ù… encodeURI Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙØ±Ø§ØºØ§Øª ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·
                  const encodedUrl = encodeURI(cleanUrl);

                  // ØµÙŠØºØ© Ø§Ù„Ù€ Intent
                  const intentUrl = 'intent://' + encodedUrl + '#Intent;scheme=' + scheme + ';type=video/*;action=android.intent.action.VIEW;end';

                  const isAndroid = /Android/i.test(navigator.userAgent);

                  if (isAndroid && window.Capacitor) {
                      try {
                          await Capacitor.Plugins.AppLauncher.openUrl({ url: intentUrl });
                      } catch (err) {
                          console.error(err);
                          // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ù€ IntentØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„ÙØªØ­ Ø¹Ø¨Ø± Ø§Ù„Ù†Ø¸Ø§Ù…
                          // alert("ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù…Ø´ØºÙ„ØŒ Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…ØªØµÙØ­..");
                          window.location.href = intentUrl; 
                      }
                  } else {
                      window.open(finalUrl, '_blank');
                  }
              });
          }
          EOF

          # 3. Ø±Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø¨Ù€ index.html
          INDEX_FILE=$(find . -name "index.html" -type f | head -n 1)
          
          node -e "
            const fs = require('fs');
            const file = '$INDEX_FILE';
            let content = fs.readFileSync(file, 'utf8');
            const scriptTag = '<script src=\"assets/player_fix.js\"></script></body>';
            
            if (!content.includes('player_fix.js')) {
                content = content.replace('</body>', scriptTag);
                fs.writeFileSync(file, content);
                console.log('âœ… Script injected into index.html');
            }
          "

      # 4. Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø¶Ø§ÙØ§Øª Capacitor
      - name: Sync Capacitor Plugins
        run: |
          npx cap add android || true
          npx cap sync android

      # 5. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
      - name: Generate Icons & Splash
        run: |
          if [ -f "assets/icon.png" ]; then npx @capacitor/assets generate --android; fi

      # 6. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª + Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª
      - name: Inject Permissions & Queries
        run: |
          # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ HTTP
          sed -i 's/<application/<application android:usesCleartextTraffic="true"/g' android/app/src/main/AndroidManifest.xml
          
          # Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
          sed -i '/<application/i <uses-permission android:name="android.permission.WRITE_SETTINGS" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml

          # Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (Ø¶Ø±ÙˆØ±ÙŠ Ø¬Ø¯Ø§Ù‹)
          sed -i '/<application/i <queries><intent><action android:name="android.intent.action.VIEW" /><data android:mimeType="video/*" /></intent><package android:name="org.videolan.vlc" /><package android:name="com.mxtech.videoplayer.ad" /><package android:name="com.mxtech.videoplayer.pro" /></queries>' android/app/src/main/AndroidManifest.xml

      # 7. Ø¥Ø¹Ø¯Ø§Ø¯ Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 8. Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù APK
      - name: Build APK with Gradle
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      # 9. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©
      - name: Rename APK
        run: |
          mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/IPTV-Elpop.apk

      # 10. Ø§Ù„Ø±ÙØ¹
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: IPTV-Elpop
          path: android/app/build/outputs/apk/debug/IPTV-Elpop.apk
