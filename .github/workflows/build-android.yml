name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. إعداد Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. تثبيت المكتبات (مع حل تعارض الإصدارات)
      - name: Install Dependencies
        run: |
          npm install --legacy-peer-deps
          npm install @capacitor/assets --save-dev --legacy-peer-deps
          npm install @capacitor/app-launcher --save --legacy-peer-deps

      # =========================================================
      # 3. (مهم جداً) استبدال كود الزر بالكامل بطريقة آمنة
      # =========================================================
      - name: Safe Replace of External Player Logic
        run: |
          cat << 'EOF' > patch_script.js
          const fs = require('fs');
          const path = require('path');

          // دالة للبحث عن ملف index.html
          function findFile(dir, fileName) {
              const files = fs.readdirSync(dir);
              for (const file of files) {
                  const fullPath = path.join(dir, file);
                  const stat = fs.statSync(fullPath);
                  if (stat.isDirectory() && file !== 'node_modules' && file !== '.git') {
                      const result = findFile(fullPath, fileName);
                      if (result) return result;
                  } else if (file === fileName) {
                      return fullPath;
                  }
              }
              return null;
          }

          const indexPath = findFile('.', 'index.html');
          if (!indexPath) { console.error('❌ index.html not found'); process.exit(1); }
          
          let content = fs.readFileSync(indexPath, 'utf8');

          // العلامات الاسترشادية من ملفك الأصلي
          const startMarker = "// 7. زر المشغل الخارجي"; // قد تختلف المسافات، لذا سنبحث بجزء منها
          const endMarker = "// 8. زر الأبعاد";

          // الكود الجديد السليم والخالي من الأخطاء
          const newCode = `
            // 7. زر المشغل الخارجي (تم الإصلاح)
            const externalPlayerBtn = document.getElementById('btn-open-external');
            if(externalPlayerBtn) {
                externalPlayerBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (!currentStreamInfo || !currentStreamInfo.url) { 
                        alert("لا يوجد فيديو قيد التشغيل"); 
                        return; 
                    }
                    
                    const url = currentStreamInfo.url;
                    // تحقق هل نحن على أندرويد؟
                    const isAndroid = /Android/i.test(navigator.userAgent);

                    if (isAndroid && window.Capacitor) {
                        const scheme = url.startsWith('https') ? 'https' : 'http';
                        const cleanUrl = url.replace(scheme + '://', '');
                        
                        // رابط Intent للأندرويد
                        const intentUrl = 'intent://' + cleanUrl + '#Intent;scheme=' + scheme + ';type=video/*;action=android.intent.action.VIEW;end';

                        try {
                            // محاولة 1: AppLauncher
                            await Capacitor.Plugins.AppLauncher.openUrl({ url: intentUrl });
                        } catch (err) {
                            console.log("AppLauncher failed, using fallback");
                            // محاولة 2: متصفح النظام (يجبر النظام على الفتح)
                            window.open(url, '_system');
                        }
                    } else {
                        // كمبيوتر
                        window.open(url, '_blank');
                    }
                };
            }
          `;

          // البحث عن مكان الكود القديم لاستبداله
          // نبحث عن النص الموجود فعلياً في الملف لضمان الاستبدال الصحيح
          // سنستخدم regex مرن يبحث عن المنطقة بين التعليق رقم 7 ورقم 8
          
          // هذه الـ Regex تبحث عن أي نص يبدأ بـ "7. زر" وينتهي بـ "8. زر"
          // وتستبدل ما بينهما بالكود الجديد
          const regex = /(\/\/\s*7\.\s*زر[\s\S]*?)(\/\/\s*8\.\s*زر)/;
          
          if (regex.test(content)) {
              content = content.replace(regex, newCode + "\n\n$2");
              fs.writeFileSync(indexPath, content, 'utf8');
              console.log("✅ Code replaced successfully between markers 7 and 8.");
          } else {
              console.warn("⚠️ Markers not found. Appending code safely to end of body.");
              // في حال فشل البحث، نضيف الكود في النهاية بطريقة آمنة
              // ونقوم بتعطيل الزر القديم إذا وجد لتجنب التعارض
              content = content.replace("const externalPlayerBtn", "// const externalPlayerBtn_DISABLED");
              
              const safeAppend = "<script>" + newCode + "</script></body>";
              content = content.replace("</body>", safeAppend);
              fs.writeFileSync(indexPath, content, 'utf8');
          }
          EOF

          node patch_script.js

      # 4. مزامنة إضافات Capacitor
      - name: Sync Capacitor Plugins
        run: |
          npx cap add android || true
          npx cap sync android

      # 5. توليد الأيقونات
      - name: Generate Icons & Splash
        run: |
          if [ -f "assets/icon.png" ]; then npx @capacitor/assets generate --android; fi

      # =========================================================
      # 6. إضافة الأذونات المطلوبة في Manifest
      # =========================================================
      - name: Inject Permissions & Queries
        run: |
          # 1. السماح بـ HTTP
          sed -i 's/<application/<application android:usesCleartextTraffic="true"/g' android/app/src/main/AndroidManifest.xml
          
          # 2. أذونات السطوع والإنترنت
          sed -i '/<application/i <uses-permission android:name="android.permission.WRITE_SETTINGS" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml

          # 3. السماح برؤية المشغلات الخارجية
          sed -i '/<application/i <queries><intent><action android:name="android.intent.action.VIEW" /><data android:mimeType="video/*" /></intent><package android:name="org.videolan.vlc" /><package android:name="com.mxtech.videoplayer.ad" /><package android:name="com.mxtech.videoplayer.pro" /></queries>' android/app/src/main/AndroidManifest.xml
          
          echo "✅ AndroidManifest patched."

      # 7. إعداد Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 8. بناء ملف APK
      - name: Build APK with Gradle
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      # 9. إعادة التسمية
      - name: Rename APK
        run: |
          mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/IPTV-Elpop.apk

      # 10. الرفع
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: IPTV-Elpop
          path: android/app/build/outputs/apk/debug/IPTV-Elpop.apk
