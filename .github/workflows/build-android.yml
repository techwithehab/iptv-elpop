name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ App Launcher)
      - name: Install Dependencies
        run: |
          npm install --legacy-peer-deps
          npm install @capacitor/assets --save-dev --legacy-peer-deps
          npm install @capacitor/app-launcher --save --legacy-peer-deps

      # =========================================================
      # 3. Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø¬Ø±Ø§Ø­ÙŠØ©: ÙƒØ´Ù Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª + Ø­Ù‚Ù† Ø§Ù„Ù…Ø´ØºÙ„
      # =========================================================
      - name: Master Fix for External Player
        run: |
          # ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù index.html
          INDEX_FILE=$(find . -name "index.html" -type f | head -n 1)
          if [ -z "$INDEX_FILE" ]; then echo "âŒ Index file not found"; exit 1; fi
          
          echo "ğŸ”§ Patching $INDEX_FILE..."

          # -------------------------------------------------------
          # Ø£) ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (let) Ø¥Ù„Ù‰ Ø¹Ø§Ù…Ø© (window)
          # Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø± Ø§Ù„Ø°ÙŠ Ø³ÙŠØ¬Ø¹Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ±Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø®ÙŠØ±Ø§Ù‹
          # -------------------------------------------------------
          sed -i 's/let currentStreamInfo/window.currentStreamInfo/g' "$INDEX_FILE"
          sed -i 's/let hls/window.hls/g' "$INDEX_FILE"
          
          echo "âœ… Variables exposed successfully."

          # -------------------------------------------------------
          # Ø¨) Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Clean Logic)
          # -------------------------------------------------------
          mkdir -p www/assets
          cat << 'EOF' > www/assets/force_player.js
          
          console.log("ğŸš€ External Player Logic Loaded");

          document.addEventListener("DOMContentLoaded", () => {
              // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ø­ØªÙ‰ Ù†Ø¬Ø¯ Ø§Ù„Ø²Ø±
              const timer = setInterval(() => {
                  const btn = document.getElementById('btn-open-external');
                  if (btn) {
                      clearInterval(timer);
                      activateButton(btn);
                  }
              }, 1000);
          });

          function activateButton(btn) {
              // 1. Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ø²Ø± Ù„Ù…Ø³Ø­ Ø£ÙŠ ÙˆØ¸Ø§Ø¦Ù Ù‚Ø¯ÙŠÙ…Ø© Ø®Ø±Ø¨Ø©
              const newBtn = btn.cloneNode(true);
              btn.parentNode.replaceChild(newBtn, btn);

              // 2. ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ù„Ù„Ø£Ø®Ø¶Ø± (Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ø¬Ø§Ø­)
              newBtn.style.color = "#00ff00"; 
              newBtn.style.border = "1px solid #00ff00";

              newBtn.addEventListener('click', async (e) => {
                  e.preventDefault();
                  e.stopPropagation();

                  // 3. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§Ù„Ø¢Ù† Ø£ØµØ¨Ø­ window.currentStreamInfo Ù…ØªØ§Ø­Ø§Ù‹ Ø¨ÙØ¶Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
                  let streamUrl = null;

                  if (window.currentStreamInfo && window.currentStreamInfo.url) {
                      streamUrl = window.currentStreamInfo.url;
                  } else if (window.hls && window.hls.url) {
                      streamUrl = window.hls.url;
                  }

                  if (!streamUrl) {
                      alert("âš ï¸ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ø¬Ø§Ù‡Ø². ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹.");
                      return;
                  }

                  // 4. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ¨Ù†Ø§Ø¡ Intent
                  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¥Ù† ÙˆØ¬Ø¯Øª
                  streamUrl = streamUrl.trim();
                  
                  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„
                  const scheme = streamUrl.startsWith('https') ? 'https' : 'http';
                  const cleanUrl = streamUrl.replace(scheme + '://', '');
                  
                  // ØªØ´ÙÙŠØ± Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙƒØ³Ø± Ø§Ù„Ù€ Intent
                  // ÙˆÙ„ÙƒÙ† Ø§Ù„Ù€ intent ÙŠØ­ØªØ§Ø¬ Ø±Ø§Ø¨Ø· Ø®Ø§Ù… ØºØ§Ù„Ø¨Ø§Ù‹ØŒ Ù„Ø°Ø§ Ø³Ù†ØªØ±Ùƒ Ø§Ù„ØªØ´ÙÙŠØ± Ù„Ù„Ù…Ø³Ø§ÙØ§Øª ÙÙ‚Ø·
                  
                  // Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø³Ø­Ø±ÙŠØ© Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ (ØªÙØªØ­ VLC/MX Ù…Ø¨Ø§Ø´Ø±Ø©)
                  const intentUrl = 'intent://' + cleanUrl + '#Intent;scheme=' + scheme + ';type=video/*;action=android.intent.action.VIEW;end;';

                  console.log("Launching: " + intentUrl);

                  const isAndroid = /Android/i.test(navigator.userAgent);

                  if (isAndroid && window.Capacitor) {
                      try {
                          // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ©
                          await Capacitor.Plugins.AppLauncher.openUrl({ url: intentUrl });
                      } catch (err) {
                          console.error("AppLauncher failed, using fallback", err);
                          // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© (Fallback)
                          window.location.href = intentUrl;
                      }
                  } else {
                      // Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
                      window.open(streamUrl, '_blank');
                  }
              });
              
              console.log("âœ… Button Activated!");
          }
          EOF

          # -------------------------------------------------------
          # Ø¬) Ø±Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù€ index.html
          # -------------------------------------------------------
          # Ù†Ø³ØªØ®Ø¯Ù… perl Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ù‚Ø¨Ù„ </body>
          perl -i -pe 's|</body>|<script src="assets/force_player.js"></script></body>|' "$INDEX_FILE"
          
          echo "âœ… Script injected."

      # 4. Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø¶Ø§ÙØ§Øª Capacitor
      - name: Sync Capacitor Plugins
        run: |
          npx cap add android || true
          npx cap sync android

      # 5. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
      - name: Generate Icons & Splash
        run: |
          if [ -f "assets/icon.png" ]; then npx @capacitor/assets generate --android; fi

      # 6. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù€ Intent)
      - name: Inject Permissions & Queries
        run: |
          # 1. Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ Cleartext (HTTP)
          sed -i 's/<application/<application android:usesCleartextTraffic="true"/g' android/app/src/main/AndroidManifest.xml
          
          # 2. Ø£Ø°ÙˆÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
          sed -i '/<application/i <uses-permission android:name="android.permission.WRITE_SETTINGS" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml

          # 3. Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø±Ø¤ÙŠØ© VLC Ùˆ MX Player (Ø¨Ø¯ÙˆÙ†Ù‡Ø§ ÙŠÙØ´Ù„ Ø§Ù„Ù€ Intent ÙÙŠ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ 11+)
          sed -i '/<application/i <queries><intent><action android:name="android.intent.action.VIEW" /><data android:mimeType="video/*" /></intent><package android:name="org.videolan.vlc" /><package android:name="com.mxtech.videoplayer.ad" /><package android:name="com.mxtech.videoplayer.pro" /></queries>' android/app/src/main/AndroidManifest.xml

      # 7. Ø¥Ø¹Ø¯Ø§Ø¯ Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 8. Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù APK
      - name: Build APK with Gradle
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      # 9. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©
      - name: Rename APK
        run: |
          mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/IPTV-Elpop.apk

      # 10. Ø§Ù„Ø±ÙØ¹
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: IPTV-Elpop
          path: android/app/build/outputs/apk/debug/IPTV-Elpop.apk
