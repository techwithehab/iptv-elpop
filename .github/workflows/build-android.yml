name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      - name: Install Dependencies
        run: |
          npm install --legacy-peer-deps
          npm install @capacitor/assets --save-dev --legacy-peer-deps
          npm install @capacitor/app-launcher --save --legacy-peer-deps

      # =========================================================
      # 3. Ø§Ù„Ø­Ù„ Ø§Ù„Ø¢Ù…Ù†: Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù JS Ù…Ù†ÙØµÙ„ ÙˆØ±Ø¨Ø·Ù‡ (Ù„Ù…Ù†Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø£Ù‚ÙˆØ§Ø³)
      # =========================================================
      - name: Create External Player Fix Script
        run: |
          # 1. ØªØ­Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† Ù…Ø¬Ù„Ø¯ assets
          # Ù†Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¬Ù„Ø¯ assets Ø¯Ø§Ø®Ù„ www Ø£Ùˆ ÙÙŠ Ø§Ù„Ø¬Ø°Ø±
          ASSETS_DIR=$(find . -type d -name "assets" | head -n 1)
          if [ -z "$ASSETS_DIR" ]; then
            # Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„Ù…Ø¬Ù„Ø¯ØŒ Ù†Ù†Ø´Ø¦Ù‡ Ø¯Ø§Ø®Ù„ www (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù€ Capacitor)
            mkdir -p www/assets
            ASSETS_DIR="www/assets"
          fi
          echo "ğŸ“‚ Assets directory found at: $ASSETS_DIR"

          # 2. ÙƒØªØ§Ø¨Ø© ÙƒÙˆØ¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ÙÙŠ Ù…Ù„Ù Ù…Ù†ÙØµÙ„ (player_fix.js)
          # ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ Ø¢Ù…Ù†Ø© Ø¬Ø¯Ø§Ù‹ ÙˆÙ„Ø§ ØªØ³Ø¨Ø¨ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ HTML
          cat << 'EOF' > "$ASSETS_DIR/player_fix.js"
          
          console.log("ğŸ”§ Player Fix Script Loaded Successfully");

          document.addEventListener("DOMContentLoaded", () => {
              // Ù†Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± ØªÙ… Ø±Ø³Ù…Ù‡Ø§
              setTimeout(initExternalPlayerFix, 2000);
          });

          function initExternalPlayerFix() {
              const btn = document.getElementById('btn-open-external');
              
              if (!btn) {
                  console.warn("âš ï¸ Button 'btn-open-external' not found yet, retrying...");
                  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙÙŠ Ø­Ø§Ù„ ØªØ£Ø®Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
                  setTimeout(initExternalPlayerFix, 1000);
                  return;
              }

              console.log("âœ… Button found! Applying fix...");

              // Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ø²Ø± Ù„Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ ÙˆØ¸Ø§Ø¦Ù Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¹Ø·Ù„Ø© (Ù†Ø¸Ø§ÙØ© ØªØ§Ù…Ø©)
              const newBtn = btn.cloneNode(true);
              btn.parentNode.replaceChild(newBtn, btn);

              // Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
              newBtn.addEventListener('click', async (e) => {
                  e.preventDefault();
                  e.stopPropagation();

                  console.log("ğŸ–±ï¸ External Player Button Clicked");

                  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                  // Ù†Ø³ØªØ®Ø¯Ù… window.currentStreamInfo Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
                  const info = window.currentStreamInfo;
                  
                  if (!info || !info.url) {
                      alert("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù„ØªØ´ØºÙŠÙ„.");
                      return;
                  }

                  const url = info.url;
                  const isAndroid = /Android/i.test(navigator.userAgent);
                  
                  // Ø§Ù„Ø­Ù„ Ø§Ù„Ø³Ø­Ø±ÙŠ: Ø§Ø³ØªØ®Ø¯Ø§Ù… _system
                  // Ù‡Ø°Ø§ ÙŠØ¹Ù…Ù„ Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Capacitor Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø£Ù… Ù„Ø§
                  if (isAndroid && window.Capacitor) {
                      try {
                          await Capacitor.Plugins.Browser.open({ url: url, windowName: '_system' });
                      } catch (err) {
                          console.error("Capacitor Browser failed", err);
                          window.open(url, '_system');
                      }
                  } else {
                      window.open(url, '_blank');
                  }
              });
              
              // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø²Ø± ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡
              newBtn.style.border = "2px solid #00ff00"; // Ø­Ø¯ÙˆØ¯ Ø®Ø¶Ø±Ø§Ø¡ Ù…Ø¤Ù‚ØªØ© Ù„Ù„ØªØ£ÙƒØ¯
          }
          EOF

          echo "âœ… File player_fix.js created successfully."

          # 3. Ø±Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù€ index.html
          # Ù†Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù index.html
          INDEX_FILE=$(find . -name "index.html" -type f | head -n 1)
          
          # Ù†Ù‚ÙˆÙ… Ø¨Ø­Ù‚Ù† Ø³Ø·Ø± Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù€ body Ù…Ø¨Ø§Ø´Ø±Ø©
          # Ù†Ø³ØªØ®Ø¯Ù… Node.js Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ© Ù„Ø£Ù†Ù‡Ø§ Ø£Ø¯Ù‚ Ù…Ù† sed ÙÙŠ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª
          node -e "
            const fs = require('fs');
            const file = '$INDEX_FILE';
            let content = fs.readFileSync(file, 'utf8');
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ø³Ø¨ÙŠ Ø§Ù„ØµØ­ÙŠØ­
            const scriptTag = '<script src=\"assets/player_fix.js\"></script></body>';
            
            if (!content.includes('player_fix.js')) {
                content = content.replace('</body>', scriptTag);
                fs.writeFileSync(file, content);
                console.log('âœ… Script injected into index.html');
            } else {
                console.log('â„¹ï¸ Script already present');
            }
          "

      # 4. Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø¶Ø§ÙØ§Øª Capacitor
      - name: Sync Capacitor Plugins
        run: |
          npx cap add android || true
          npx cap sync android

      # 5. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
      - name: Generate Icons & Splash
        run: |
          if [ -f "assets/icon.png" ]; then npx @capacitor/assets generate --android; fi

      # 6. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      - name: Inject Permissions & Queries
        run: |
          sed -i 's/<application/<application android:usesCleartextTraffic="true"/g' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i <uses-permission android:name="android.permission.WRITE_SETTINGS" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i <queries><intent><action android:name="android.intent.action.VIEW" /><data android:mimeType="video/*" /></intent><package android:name="org.videolan.vlc" /><package android:name="com.mxtech.videoplayer.ad" /><package android:name="com.mxtech.videoplayer.pro" /></queries>' android/app/src/main/AndroidManifest.xml

      # 7. Ø¥Ø¹Ø¯Ø§Ø¯ Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 8. Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù APK
      - name: Build APK with Gradle
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      # 9. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©
      - name: Rename APK
        run: |
          mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/IPTV-Elpop.apk

      # 10. Ø§Ù„Ø±ÙØ¹
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: IPTV-Elpop
          path: android/app/build/outputs/apk/debug/IPTV-Elpop.apk
