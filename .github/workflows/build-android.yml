name: Build Android APK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª (Ù…Ø¹ Ø­Ù„ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙˆØ§ÙÙ‚)
      - name: Install Dependencies
        run: |
          npm install --legacy-peer-deps
          npm install @capacitor/assets --save-dev --legacy-peer-deps
          npm install @capacitor/app-launcher --save --legacy-peer-deps

      # =========================================================
      # 3. Ø§Ù„Ø­Ù„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: Ø­Ù‚Ù† ÙƒÙˆØ¯ Ø§Ù„Ø²Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³ÙƒØ±Ø¨Øª Node.js Ù…Ø³ØªÙ‚Ù„
      # =========================================================
      - name: Safe Inject External Player Logic
        run: |
          # Ù†ÙƒØªØ¨ Ø³ÙƒØ±Ø¨Øª JS Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© (Ù‡Ø°Ø§ ÙŠÙ…Ù†Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù€ Syntax ØªÙ…Ø§Ù…Ø§Ù‹)
          cat << 'EOF' > injector.js
          const fs = require('fs');
          const path = require('path');

          // Ø¯Ø§Ù„Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù index.html ÙÙŠ Ø£ÙŠ Ù…Ø¬Ù„Ø¯ ÙØ±Ø¹ÙŠ
          function findFile(dir, name) {
              const files = fs.readdirSync(dir);
              for (const file of files) {
                  const fullPath = path.join(dir, file);
                  const stat = fs.statSync(fullPath);
                  if (stat.isDirectory()) {
                      if (file !== 'node_modules' && file !== '.git') {
                          const res = findFile(fullPath, name);
                          if (res) return res;
                      }
                  } else if (file === name) {
                      return fullPath;
                  }
              }
              return null;
          }

          const indexPath = findFile('.', 'index.html');
          if (!indexPath) {
              console.error("âŒ Error: index.html not found!");
              process.exit(1);
          }
          console.log(`âœ… Found index.html at: ${indexPath}`);

          let content = fs.readFileSync(indexPath, 'utf8');

          // 1. ØªØ¹Ø·ÙŠÙ„ Ø£ÙŠ ÙƒÙˆØ¯ Ù‚Ø¯ÙŠÙ… Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ø²Ø± (Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø§Ø±Ø¶)
          content = content.replace(/externalPlayerBtn\.onclick/g, '// DISABLED_OLD_CLICK_externalPlayerBtn.onclick');

          // 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù†Ø¶ÙŠÙÙ‡ Ù‚Ø¨Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù€ body)
          // Ù†Ø³ØªØ®Ø¯Ù… cloneNode Ù„Ù…Ø³Ø­ Ø£ÙŠ events Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ø§Ù„Ù‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
          const newScript = `
          <script>
          document.addEventListener("DOMContentLoaded", () => {
              setTimeout(() => {
                  console.log("ğŸš€ Injecting External Player Fix...");
                  const btnExt = document.getElementById('btn-open-external');
                  
                  if(btnExt) {
                      // Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ø²Ø± Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ (Ù‡Ø°Ø§ ÙŠØ²ÙŠÙ„ Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ù‚Ø¯ÙŠÙ…Ø© Ù…Ø¹Ø·Ù„Ø©)
                      const newBtn = btnExt.cloneNode(true);
                      btnExt.parentNode.replaceChild(newBtn, btnExt);
                      
                      newBtn.onclick = async (e) => {
                          e.stopPropagation();
                          e.preventDefault();
                          
                          // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø±Ø§Ø¨Ø·
                          if (typeof currentStreamInfo === 'undefined' || !currentStreamInfo || !currentStreamInfo.url) {
                              alert("âš ï¸ Ø®Ø·Ø£: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹.");
                              return;
                          }
                          
                          const url = currentStreamInfo.url;
                          const isAndroid = /Android/i.test(navigator.userAgent);
                          
                          if (isAndroid && window.Capacitor) {
                              try {
                                  // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø£ÙØ¶Ù„: ÙØªØ­ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù†Ø¸Ø§Ù…ÙŠ Ø§Ù„Ø°ÙŠ Ø¨Ø¯ÙˆØ±Ù‡ ÙŠÙØªØ­ Ø§Ù„Ù…Ø´ØºÙ„Ø§Øª
                                  await Capacitor.Plugins.Browser.open({ url: url, windowName: '_system' });
                              } catch (err) {
                                  console.error("Browser plugin failed", err);
                                  // Ø®Ø·Ø© Ø¨Ø¯ÙŠÙ„Ø©
                                  window.open(url, '_system');
                              }
                          } else {
                              // Ù„Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
                              window.open(url, '_blank');
                          }
                      };
                      console.log("âœ… External Player Button Patched Successfully!");
                  } else {
                      console.error("âŒ Button 'btn-open-external' not found in DOM.");
                  }
              }, 2500); // Ù†Ù†ØªØ¸Ø± 2.5 Ø«Ø§Ù†ÙŠØ© Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
          });
          </script>
          </body>
          `;

          // 3. Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙˆØ³Ù… Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
          content = content.replace('</body>', newScript);
          
          fs.writeFileSync(indexPath, content);
          console.log("âœ… index.html has been updated successfully.");
          EOF

          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
          node injector.js

      # 4. Ù…Ø²Ø§Ù…Ù†Ø© Ø¥Ø¶Ø§ÙØ§Øª Capacitor
      - name: Sync Capacitor Plugins
        run: |
          npx cap add android || true
          npx cap sync android

      # 5. ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
      - name: Generate Icons & Splash
        run: |
          if [ -f "assets/icon.png" ]; then npx @capacitor/assets generate --android; fi

      # 6. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Manifest (Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹)
      - name: Inject Permissions & Queries
        run: |
          # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ HTTP
          sed -i 's/<application/<application android:usesCleartextTraffic="true"/g' android/app/src/main/AndroidManifest.xml
          
          # Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ø³Ø·ÙˆØ¹ ÙˆØ§Ù„Ø¥Ù†ØªØ±Ù†Øª
          sed -i '/<application/i <uses-permission android:name="android.permission.WRITE_SETTINGS" />' android/app/src/main/AndroidManifest.xml
          sed -i '/<application/i <uses-permission android:name="android.permission.INTERNET" />' android/app/src/main/AndroidManifest.xml

          # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø±Ø¤ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (VLC, MX Player)
          sed -i '/<application/i <queries><intent><action android:name="android.intent.action.VIEW" /><data android:mimeType="video/*" /></intent><package android:name="org.videolan.vlc" /><package android:name="com.mxtech.videoplayer.ad" /><package android:name="com.mxtech.videoplayer.pro" /></queries>' android/app/src/main/AndroidManifest.xml

      # 7. Ø¥Ø¹Ø¯Ø§Ø¯ Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 8. Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù APK
      - name: Build APK with Gradle
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      # 9. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ©
      - name: Rename APK
        run: |
          mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/IPTV-Elpop.apk

      # 10. Ø§Ù„Ø±ÙØ¹
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: IPTV-Elpop
          path: android/app/build/outputs/apk/debug/IPTV-Elpop.apk
