name: Build Android APK (No Shrink + ARM Support)

on:
  push:
    branches:
      - main
      - master

jobs:
  build:
    name: Build Robust APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Dependencies
        run: npm install

      - name: Prepare Web Assets
        run: |
          mkdir -p www
          rsync -av --exclude='node_modules' --exclude='.git' --exclude='android' --exclude='www' . www/

      - name: Initialize Capacitor Android
        run: |
          npx cap add android
          npx cap sync android

      # ========================================================
      # Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Gradle Ù…Ø¨Ø§Ø´Ø±Ø©
      # ========================================================
      - name: Force Disable Shrinking & Add ARM Support
        run: |
          cd android/app
          
          echo "ğŸ”¥ Modifying build.gradle to disable R8 and force ARM libs..."

          # 1. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù€ Minification Ùˆ Shrinking ØªÙ…Ø§Ù…Ø§Ù‹ (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯)
          # Ù†Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ ØªÙØ¹ÙŠÙ„ Ù„Ù„Ø­Ù…Ø§ÙŠØ© ÙˆÙ†Ù‚ÙˆÙ… Ø¨Ø¥ÙŠÙ‚Ø§ÙÙ‡
          sed -i 's/minifyEnabled true/minifyEnabled false/g' build.gradle
          sed -i 's/shrinkResources true/shrinkResources false/g' build.gradle
          
          # 2. Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ù…Ø¹Ù…Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù‡Ø§ØªÙ (ARM) Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ§Ù‹
          # Ù†Ø¶ÙŠÙ ÙƒØªÙ„Ø© ndk Ø¯Ø§Ø®Ù„ defaultConfig Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
          if ! grep -q "abiFilters" build.gradle; then
            sed -i '/defaultConfig {/a \        ndk { abiFilters "armeabi-v7a", "arm64-v8a", "x86", "x86_64" }' build.gradle
          fi

          # Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„Ù Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
          echo "ğŸ“„ Content of build.gradle after modification:"
          cat build.gradle

      # ========================================================
      # Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª (Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)
      # ========================================================
      - name: Fix AndroidManifest (Internet & Cleartext)
        run: |
          cd android/app/src/main
          
          # Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
          if ! grep -q "android.permission.INTERNET" AndroidManifest.xml; then
             sed -i '/<manifest/a \    <uses-permission android:name="android.permission.INTERNET" />' AndroidManifest.xml
          fi
          
          # Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
          if ! grep -q "android.permission.READ_EXTERNAL_STORAGE" AndroidManifest.xml; then
             sed -i '/<manifest/a \    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />' AndroidManifest.xml
          fi

          # ØªÙØ¹ÙŠÙ„ Cleartext Traffic Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø©
          sed -i 's/<application/& android:usesCleartextTraffic="true"/' AndroidManifest.xml
          
          echo "âœ… Manifest Fixed"

      # Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù APK (Debug) - Ù†Ø³Ø®Ø© Ø§Ù„Ø¯ÙŠØ¨Ø§Ø¬ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ø§Ù‹
      - name: Build APK (Debug)
        working-directory: ./android
        run: ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: IPTV-Elpop-Final-Fix
          path: android/app/build/outputs/apk/debug/app-debug.apk
