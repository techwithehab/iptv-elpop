name: Build Android APK (Multidex + NoConflict)

on:
  push:
    branches:
      - main
      - master

jobs:
  build:
    name: Build Stability Fix
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Dependencies
        run: npm install

      - name: Prepare Web Assets
        run: |
          mkdir -p www
          rsync -av --exclude='node_modules' --exclude='.git' --exclude='android' --exclude='www' . www/

      - name: Initialize Capacitor Android
        run: |
          npx cap add android
          npx cap sync android

      # ========================================================
      # Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø­Ø§Ø³Ù…Ø©: ØªÙØ¹ÙŠÙ„ Multidex ÙˆØ­Ù„ ØªØ¶Ø§Ø±Ø¨ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      # ========================================================
      - name: Inject Multidex & Dependency Resolution
        run: |
          cd android/app
          
          echo "ğŸ’‰ Injecting Multidex and Dependency fixes..."

          # 1. ØªÙØ¹ÙŠÙ„ MultiDex ÙÙŠ defaultConfig
          # Ù†Ø¨Ø­Ø« Ø¹Ù† Ø³Ø·Ø± versionName ÙˆÙ†Ø¶ÙŠÙ ØªØ­ØªÙ‡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ØªÙŠØ¯ÙƒØ³
          sed -i '/versionName/a \        multiDexEnabled true' build.gradle

          # 2. Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© multidex Ø¥Ù„Ù‰ dependencies
          sed -i '/dependencies {/a \    implementation "androidx.multidex:multidex:2.0.1"' build.gradle

          # 3. Ø¥Ø¬Ø¨Ø§Ø± Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© Ø­Ù„ Ø§Ù„Ù†Ø²Ø§Ø¹Ø§Øª (Dependency Resolution Strategy)
          # Ù‡Ø°Ø§ ÙŠÙ…Ù†Ø¹ Ø§Ù„ÙƒØ±Ø§Ø´ Ø§Ù„Ù†Ø§ØªØ¬ Ø¹Ù† Ø§Ø®ØªÙ„Ø§Ù Ù†Ø³Ø® Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
          cat <<EOF >> build.gradle
          
          configurations.all {
              resolutionStrategy {
                  force 'androidx.core:core-ktx:1.12.0'
                  force 'androidx.work:work-runtime:2.9.0'
              }
          }
          EOF

          # 4. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ù…Ø§ÙŠØ© (ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©) Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯
          sed -i 's/minifyEnabled true/minifyEnabled false/g' build.gradle
          sed -i 's/shrinkResources true/shrinkResources false/g' build.gradle
          
          # 5. Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª (ABI Filters)
          if ! grep -q "abiFilters" build.gradle; then
            sed -i '/defaultConfig {/a \        ndk { abiFilters "armeabi-v7a", "arm64-v8a", "x86", "x86_64" }' build.gradle
          fi

          echo "âœ… build.gradle patched successfully."
          cat build.gradle

      # ========================================================
      # Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø§Ù†ÙŠÙØ³Øª (Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª + HTTP)
      # ========================================================
      - name: Fix AndroidManifest (Internet & Cleartext)
        run: |
          cd android/app/src/main
          
          # Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
          if ! grep -q "android.permission.INTERNET" AndroidManifest.xml; then
             sed -i '/<manifest/a \    <uses-permission android:name="android.permission.INTERNET" />' AndroidManifest.xml
          fi
          
          # Ø¥Ø¶Ø§ÙØ© Ø¥Ø°Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
          if ! grep -q "android.permission.READ_EXTERNAL_STORAGE" AndroidManifest.xml; then
             sed -i '/<manifest/a \    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />' AndroidManifest.xml
          fi

          # ØªÙØ¹ÙŠÙ„ Cleartext Traffic + Hardware Acceleration
          # Ø¥Ø¶Ø§ÙØ© Ù‡Ø§Ø±Ø¯ÙˆÙŠØ± Ø§ÙƒØ³Ù„Ø±ÙŠØ´Ù† Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ
          sed -i 's/<application/& android:usesCleartextTraffic="true" android:hardwareAccelerated="true"/' AndroidManifest.xml
          
          echo "âœ… Manifest Fixed"

      # Ø¨Ù†Ø§Ø¡ Ù…Ù„Ù APK (Clean Build) - Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù‡Ù†Ø§
      - name: Build APK (Clean & Debug)
        working-directory: ./android
        run: |
          ./gradlew clean
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: IPTV-Elpop-Multidex-Fix
          path: android/app/build/outputs/apk/debug/app-debug.apk
