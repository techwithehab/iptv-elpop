<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: gap: content: https://ssl.gstatic.com; style-src * 'unsafe-inline'; media-src *; img-src * data: content:; connect-src * blob:;">


  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>IPTV ELPOP</title>
<link rel="icon" type="image/png" href="./assets/images/logo.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#180c2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS & FontAwesome -->
<script src="tailwind.js"></script>
<script src="cordova.js"></script> 
    <link rel="stylesheet" href="assets/libs/fontawesome/css/all.min.css">
    
    <!-- HLS.js -->
    <script src="./assets/libs/hls.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Cairo', 'sans-serif'] },
                    colors: {
                        'smarters-bg': '#1a0b2e',
                        'smarters-card': 'rgba(255, 255, 255, 0.05)',
                        'smarters-blue': '#0097e6',
                        'smarters-purple': '#7158e2',
                        'smarters-orange': '#e1b12c',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Smarters Pro Theme Styles --- */
        body {
            background-color: #0f0518;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: cover;
            background-attachment: fixed;
            color: #fff;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Cairo', sans-serif;
            overflow-x: hidden;
        }
/* تحسين السكرول للموبايل */
.scroller-smooth {
    -webkit-overflow-scrolling: touch; /* يجعل السكرول ناعم جداً في الموبايل */
    scroll-behavior: smooth;
    overscroll-behavior-y: contain; /* يمنع الصفحة من الارتداد المزعج */
}

/* تسريع الأداء بتقليل العمليات الرسومية */
.main-card, .poster-card {
    /* استبدل backdrop-filter إذا كان الجهاز بطيئاً، أو اتركه إذا كانت الأجهزة قوية */
    /* backdrop-filter: blur(10px);  <-- هذا السطر هو سبب اللاق الرئيسي */
    background: rgba(30, 39, 46, 0.8); /* لون خلفية أغمق قليلاً بدلاً من البلور */
    transform: translateZ(0); /* تفعيل تسريع كرت الشاشة GPU */
    will-change: transform; /* يخبر المتصفح بتجهيز العنصر للتحريك */
}

        /* Sidebar Styles */
        .cat-item {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #b2bec3;
        }
        .cat-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }
        /* Active State (Turquoise/Teal like screenshot) */
        .cat-item.active {
            background: #1289A7; /* Teal color */
            color: white;
            font-weight: bold;
            border-left: 4px solid white; /* عكسنا الجهة عشان RTL */
        }
        .cat-count {
            background: rgba(0,0,0,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        /* تخصيص السكرول */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* البطاقات الرئيسية */
        .main-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
        .main-card:active { transform: scale(0.97); }
        .main-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.5); border-color: rgba(255,255,255,0.3); }

        /* التدرجات اللونية للأزرار */
        .gradient-live { background: linear-gradient(135deg, #0984e3 0%, #00cec9 100%); }
        .gradient-movies { background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%); }
        .gradient-series { background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%); }
        .gradient-settings { background: linear-gradient(135deg, #636e72 0%, #b2bec3 100%); }

        /* الحقول الزجاجية */
        .glass-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #6c5ce7;
            outline: none;
            box-shadow: 0 0 15px rgba(108, 92, 231, 0.3);
        }

        /* الملصقات (Posters) */
        .poster-card {
            transition: transform 0.2s;
            border-radius: 8px;
            overflow: hidden;
            background: #1e272e;
            position: relative;
            aspect-ratio: 2/3;
        }
        .poster-card:hover { transform: scale(1.05); z-index: 10; ring: 2px solid #fff; }
        .poster-overlay {
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }

        /* إخفاء شريط التمرير الأفقي في القوائم */
        .horizontal-scroll-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .horizontal-scroll-container::-webkit-scrollbar { display: none; }

        /* --- Player Styles (Fixed from Old Code) --- */
     #player-view { 
    direction: ltr; 
    background-color: #000000 !important;
    overflow: hidden; 
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    /* هذا التعديل يحل مشكلة الأزرار في الموبايل */
    height: 100vh; 
    height: 100dvh; 
    z-index: 99999;
}

/* رفع التحكمات قليلاً عن الحافة السفلية */
.player-controls-container {
    padding-bottom: env(safe-area-inset-bottom, 20px); /* يراعي هواتف آيفون وأندرويد الحديثة */
}


        .player-controls-container {
            position: absolute;
            inset: 0;
            z-index: 50;
            opacity: 0; /* مخفي افتراضياً */
            transition: opacity 0.3s ease-in-out;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.4) 50%, rgba(0, 0, 0, 0.8) 100%);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1rem;
        }

        /* عند إضافة هذا الكلاس (عن طريق JS) تظهر التحكمات */
        #player-view.controls-active .player-controls-container {
            opacity: 1;
        }

        /* طبقات اللمس للتقديم والتأخير */
        .player-seek-overlays {
            position: absolute;
            inset: 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            z-index: 40; /* تحت التحكمات وفوق الفيديو */
        }
        #player-seek-overlay-right, #player-seek-overlay-left {
            height: 100%;
            width: 100%;
        }

        /* إخفاء تحكمات الفيديو الافتراضية */
        video::-webkit-media-controls { display: none !important; }
        input[type=range] {accent-color: #6c5ce7;}
        
        /* Loader */
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: #6c5ce7;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body class="h-screen w-screen overflow-hidden select-none">


<button id="installBtn" class="hidden bg-purple-600 text-white px-4 py-2 rounded-lg mt-4">
    تثبيت التطبيق 📲
</button>

    <!-- 1. شاشة تسجيل الدخول (تصميم Smarters) -->
    <div id="login-view" class="view fixed inset-0 z-50 flex flex-col items-center justify-center p-4">
        <div class="absolute inset-0 z-0 opacity-40">
            <!-- خلفية متحركة بسيطة -->
            <div class="absolute top-0 left-0 w-full h-full bg-[url('./assets/images/login-bg.jpg')] bg-cover bg-center"></div>
        </div>
        
        <div class="relative z-10 w-full max-w-lg bg-black/60 backdrop-blur-xl p-8 rounded-3xl border border-white/10 shadow-2xl animate-fade-in-down">
            <div class="flex flex-col items-center mb-8">
                <img src="./assets/images/logo.png" class="h32- object-contain drop-shadow-2xl" alt="Logo" onerror="this.src='./assets/images/profile.png'">
                <h2 class="text-white text-2xl font-bold mt-4 tracking-wider">IPTV  <span class="text-smarters-purple">ELPOP</span></h2>
            </div>

            <div class="space-y-4">
                <div class="relative">
                    <i class="fas fa-server absolute right-4 top-4 text-gray-400"></i>
                    <input type="text" id="host" placeholder="http://domain.com:port" class="glass-input w-full p-3 pr-10 rounded-xl text-left" dir="ltr">
                </div>
                <div class="relative">
                    <i class="fas fa-user absolute right-4 top-4 text-gray-400"></i>
                    <input type="text" id="username" placeholder="Username" class="glass-input w-full p-3 pr-10 rounded-xl text-left" dir="ltr">
                </div>
                <div class="relative">
                    <i class="fas fa-lock absolute right-4 top-4 text-gray-400"></i>
                    <input type="password" id="password" placeholder="Password" class="glass-input w-full p-3 pr-10 rounded-xl text-left" dir="ltr">
                </div>

                <!-- Xtream Codes Toggle -->
                <div class="text-left">
                    <button id="toggle-xtream" class="text-xs text-smarters-blue hover:text-white underline">تسجيل الدخول برابط M3U/Xtream</button>
                    <div id="xtream-container" class="hidden mt-2 flex gap-2">
                        <input type="text" id="xtream-link" placeholder="الصق الرابط الكامل..." class="glass-input w-full p-2 text-xs rounded-lg" dir="ltr">
                        <button id="parse-link-button" class="bg-smarters-purple p-2 rounded-lg hover:bg-purple-600 transition"><i class="fas fa-magic"></i></button>
                    </div>
                </div>

                <div class="flex items-center gap-2 mt-4">
                    <input type="checkbox" id="remember-me" class="w-4 h-4 accent-smarters-purple rounded bg-gray-700 border-gray-600">
                    <label for="remember-me" class="text-sm text-gray-300">تذكر بياناتي</label>
                </div>

                <button id="login-button" class="w-full py-4 mt-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 rounded-xl font-bold text-lg shadow-lg transform transition active:scale-95 text-white">
                    تسجيل الدخول
                </button>
            </div>
        </div>
        <div class="absolute bottom-4 text-gray-500 text-xs">IPTV ELPOP</div>
    </div>

    <!-- 2. الشاشة الرئيسية (Dashboard - تصميم جديد) -->
    <div id="main-menu-view" class="view hidden h-full flex flex-col relative z-10">
        <!-- Header -->
               <div class="h-20 flex items-center justify-between px-6 md:px-10 bg-black/20 backdrop-blur-sm border-b border-white/5">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-full bg-white/5 border border-white/20 overflow-hidden flex items-center justify-center">
                    <img src="./assets/images/profile.png" class="w-full h-full object-cover" alt="Logo" onerror="this.src='./assets/images/profile.png'">
                </div>
                <div>
                    <div id="user-display-name" class="font-bold text-lg text-white">Guest</div>
                    <div class="text-xs text-green-400 flex items-center gap-1"><i class="fas fa-circle text-[8px]"></i> متصل</div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <div id="header-time" class="font-mono text-xl font-bold">00:00</div>
                    <div id="header-date" class="text-xs text-gray-400">...</div>
                </div>
                <button id="search-trigger-main" class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition"><i class="fas fa-search"></i></button>
                <button id="logout-button" class="w-10 h-10 rounded-full bg-red-600/20 hover:bg-red-600/50 text-red-500 flex items-center justify-center transition"><i class="fas fa-power-off"></i></button>
            </div>
        </div>


        <!-- Main Content Area -->
                <div class="flex-1 overflow-y-auto p-4 md:p-8 scroller-smooth pb-24">
            <div class="max-w-7xl mx-auto">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div id="btn-live" class="main-card gradient-live h-48 md:h-64 rounded-3xl cursor-pointer p-6 flex flex-col justify-between group">
                        <div class="flex justify-between items-start">
                            <div class="bg-white/20 w-14 h-14 rounded-2xl flex items-center justify-center backdrop-blur-md group-hover:scale-110 transition">
                                <i class="fas fa-tv text-2xl text-white"></i>
                            </div>
                            <span class="bg-black/20 px-3 py-1 rounded-full text-xs font-bold">LIVE</span>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold text-white mb-1">تلفزيون مباشر</h2>
                            <p class="text-blue-100 text-sm opacity-80">شاهد القنوات المفضلة</p>
                        </div>
                    </div>

                    <div id="btn-movies" class="main-card gradient-movies h-48 md:h-64 rounded-3xl cursor-pointer p-6 flex flex-col justify-between group">
                        <div class="flex justify-between items-start">
                            <div class="bg-white/20 w-14 h-14 rounded-2xl flex items-center justify-center backdrop-blur-md group-hover:scale-110 transition">
                                <i class="fas fa-film text-2xl text-white"></i>
                            </div>
                            <span class="bg-black/20 px-3 py-1 rounded-full text-xs font-bold">VOD</span>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold text-white mb-1">الأفلام</h2>
                            <p class="text-orange-100 text-sm opacity-80">أحدث الأفلام العالمية</p>
                        </div>
                    </div>

                    <div id="btn-series" class="main-card gradient-series h-48 md:h-64 rounded-3xl cursor-pointer p-6 flex flex-col justify-between group">
                        <div class="flex justify-between items-start">
                            <div class="bg-white/20 w-14 h-14 rounded-2xl flex items-center justify-center backdrop-blur-md group-hover:scale-110 transition">
                                <i class="fas fa-video text-2xl text-white"></i>
                            </div>
                            <span class="bg-black/20 px-3 py-1 rounded-full text-xs font-bold">SERIES</span>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold text-white mb-1">المسلسلات</h2>
                            <p class="text-purple-100 text-sm opacity-80">متابعة الحلقات</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div id="btn-favorites-shortcut" class="main-card bg-white/5 h-24 rounded-2xl flex items-center px-4 gap-4 cursor-pointer hover:bg-white/10 border-r-4 border-red-500">
                        <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center text-red-500"><i class="fas fa-heart"></i></div>
                        <div><div class="font-bold">المفضلة</div><div class="text-xs text-gray-400">قائمتك</div></div>
                    </div>
                    
                    <div id="btn-history-shortcut" class="main-card bg-white/5 h-24 rounded-2xl flex items-center px-4 gap-4 cursor-pointer hover:bg-white/10 border-r-4 border-yellow-500">
                        <div class="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-500"><i class="fas fa-history"></i></div>
                        <div><div class="font-bold">السجل</div><div class="text-xs text-gray-400">المشاهدة</div></div>
                    </div>

                    <div id="btn-continue-shortcut" class="main-card bg-white/5 h-24 rounded-2xl flex items-center px-4 gap-4 cursor-pointer hover:bg-white/10 border-r-4 border-purple-500">
    <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-500"><i class="fas fa-play-circle"></i></div>
    <div><div class="font-bold">استكمال المشاهدة</div><div class="text-xs text-gray-400">متابعة العرض</div></div>
</div>


                    <div id="btn-settings-shortcut" class="main-card bg-white/5 h-24 rounded-2xl flex items-center px-4 gap-4 cursor-pointer hover:bg-white/10 border-r-4 border-gray-500">
                        <div class="w-10 h-10 rounded-full bg-gray-500/20 flex items-center justify-center text-gray-400"><i class="fas fa-cog"></i></div>
                        <div><div class="font-bold">الحساب</div><div class="text-xs text-gray-400">المعلومات</div></div>
                    </div>
                </div>

                <div id="dashboard-container" class="mt-8 space-y-6"></div>
            </div> </div> </div> 

    <div id="content-view" class="view hidden h-full flex flex-col bg-smarters-bg z-20 absolute inset-0">
        <div class="h-16 flex-shrink-0 flex items-center justify-between px-4 bg-black/60 border-b border-white/5 backdrop-blur-md">
            <div class="flex items-center gap-3">
                <button id="back-button" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center transition">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <h2 id="content-title" class="text-xl font-bold truncate text-white">العنوان</h2>
            </div>
            <div class="flex gap-2">
                 <button id="search-trigger-content" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center"><i class="fas fa-search"></i></button>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <div id="category-sidebar" class="w-1/3 md:w-1/4 lg:w-1/5 bg-black/40 border-l border-white/5 overflow-y-auto flex flex-col pb-20">
            </div>

            <div id="content-container" class="flex-1 overflow-y-auto p-4 bg-gradient-to-br from-smarters-bg to-black relative">
                
                <div id="inner-loader" class="hidden absolute inset-0 flex items-center justify-center z-10 bg-black/50">
                    <div class="spinner"></div>
                </div>

                                <div id="series-info-container" class="hidden mb-6 animate-fade-in-up relative">
                    <div class="flex flex-col bg-white/5 p-6 rounded-3xl border border-white/5 relative overflow-hidden">
                        
                                       
                        <div class="relative z-10 flex flex-col md:flex-row gap-8 mb-8">
                            <div class="w-full md:w-1/3 max-w-[280px] mx-auto md:mx-0">
                                <img id="series-cover" src="" class="w-full rounded-2xl shadow-2xl border border-white/10 aspect-[2/3] object-cover bg-gray-800">
                            </div>
                            
                            <div class="flex-1 flex flex-col justify-center text-center md:text-right">
                                <h2 id="series-title" class="text-3xl md:text-4xl font-bold text-white mb-4 drop-shadow-lg leading-tight"></h2>
                                
                                <div id="series-meta" class="flex flex-wrap justify-center md:justify-start gap-4 text-gray-300 mb-6 text-sm font-bold">
                                    </div>
                                
                                <p id="series-plot" class="text-gray-200 text-sm md:text-base leading-relaxed mb-6"></p>
                                
                                <div class="flex justify-center md:justify-start mb-6">
                                    <button id="series-fav-btn" class="bg-white/10 hover:bg-white/20 text-white px-6 py-2 rounded-xl font-bold transition border border-white/10 flex items-center gap-2">
                                        <i class="far fa-heart"></i> <span>إضافة للمفضلة</span>
                                    </button>
                                </div>

                                <div id="series-cast" class="mt-2"></div>
                            </div>
                        </div>

                        <div class="relative z-10 border-t border-white/10 pt-6">
                            <div class="flex items-center gap-3 mb-4">
                                <i class="fas fa-layer-group text-smarters-purple text-xl"></i>
                                <h3 class="text-xl font-bold text-white">المواسم والحلقات</h3>
                            </div>
                            
                            <div id="season-tabs" class="flex overflow-x-auto gap-3 py-2 no-scrollbar mb-4"></div>
                            
                            <div id="episodes-grid" class="flex flex-col gap-2 w-full"></div>
                        </div>
                    </div>
                </div>


                <div id="movie-info-container" class="hidden mb-6 animate-fade-in-up relative">
                    <div class="flex flex-col md:flex-row gap-8 bg-white/5 p-6 rounded-3xl border border-white/5 relative overflow-hidden">
                                                
                        <div class="relative z-10 w-full md:w-1/3 max-w-[300px] mx-auto md:mx-0">
                            <img id="movie-poster" src="" class="w-full rounded-2xl shadow-2xl border border-white/10 aspect-[2/3] object-cover">
                        </div>
                        
                        <div class="relative z-10 flex-1 flex flex-col justify-center text-center md:text-right">
                            <h2 id="movie-title-text" class="text-3xl md:text-4xl font-bold text-white mb-4 drop-shadow-lg"></h2>
                            
                            <div id="movie-meta" class="flex flex-wrap justify-center md:justify-start gap-4 text-gray-300 mb-6 text-sm font-bold"></div>
                            
                            <p id="movie-desc" class="text-gray-200 text-sm md:text-base leading-relaxed mb-8">
                   جاري جلب تفاصيل الفيلم...
                            </p>

                            <div class="flex flex-wrap gap-4 justify-center md:justify-start">
                                <button id="btn-play-movie-tmdb" class="bg-smarters-purple hover:bg-purple-600 text-white px-8 py-3 rounded-xl font-bold text-lg transition flex items-center gap-2 shadow-lg shadow-purple-900/50">
                                    <i class="fas fa-play"></i> مشاهدة الآن
                                </button>
                                <button id="btn-fav-movie-tmdb" class="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-xl font-bold transition border border-white/10">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>

                            <div id="movie-cast" class="mt-8"></div>
                        </div>
                    </div>
                </div>

                <div id="content-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 pb-20"></div>

            </div>
        </div>
    </div>


    

  
            

    <!-- 4. المشغل (Player) -->
       <div id="player-view" class="view hidden fixed inset-0 bg-black overflow-hidden touch-none w-screen h-screen z-[99999]">
    <div id="brightness-overlay" class="absolute inset-0 z-0 bg-black pointer-events-none opacity-0"></div>

    <video id="videoPlayer" class="w-full h-full object-contain bg-black" autoplay playsinline></video>

    <div id="gesture-area" class="absolute inset-0 z-10 grid grid-cols-2">
        <div id="touch-left" class="h-full w-full"></div> <div id="touch-right" class="h-full w-full"></div> </div>

    <div id="center-feedback" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/60 backdrop-blur-md rounded-2xl p-6 flex flex-col items-center justify-center min-w-[120px] opacity-0 transition-opacity duration-200 pointer-events-none z-30">
        <i id="feedback-icon" class="fas fa-sun text-4xl text-white mb-3"></i>
        <div class="text-2xl font-bold text-white mb-2"><span id="feedback-text">50</span>%</div>
        <div class="w-full h-1.5 bg-gray-600 rounded-full overflow-hidden">
            <div id="feedback-bar" class="h-full bg-smarters-purple w-1/2"></div>
        </div>
    </div>

    <div id="seek-feedback-right" class="absolute top-1/2 right-20 -translate-y-1/2 bg-black/50 p-4 rounded-full text-white opacity-0 transition pointer-events-none z-30">
        <i class="fas fa-forward text-2xl"></i> <span class="font-bold">+10s</span>
    </div>
    <div id="seek-feedback-left" class="absolute top-1/2 left-20 -translate-y-1/2 bg-black/50 p-4 rounded-full text-white opacity-0 transition pointer-events-none z-30">
        <i class="fas fa-backward text-2xl"></i> <span class="font-bold">-10s</span>
    </div>

    <div id="player-loading-spinner" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none z-20">
        <div class="spinner border-4 border-white/20 border-l-smarters-purple w-12 h-12"></div>
    </div>

    <div id="player-ui" class="absolute inset-0 z-40 flex flex-col justify-between p-4 md:p-8 transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="flex justify-between items-center pointer-events-auto">
            <button id="player-back-button" class="w-10 h-10 rounded-full bg-black/40 text-white hover:bg-white/20 flex items-center justify-center backdrop-blur-sm"><i class="fas fa-arrow-right"></i></button>
            <h3 id="player-overlay-title" class="text-white font-bold text-lg shadow-black drop-shadow-md truncate max-w-[60%] text-center"></h3>
            <div class="w-10"></div> </div>

        <div class="bg-black/60 backdrop-blur-md rounded-2xl p-4 border border-white/5 pointer-events-auto pb-6 md:pb-4"> <div class="flex items-center gap-3 mb-2 text-xs font-mono text-gray-300">
                <span id="player-time-current">00:00</span>
                <div id="player-progress-container" class="flex-1 h-8 flex items-center cursor-pointer group">
                    <div class="w-full h-1.5 bg-white/20 rounded-full overflow-hidden relative">
                        <div id="player-progress-filled" class="absolute top-0 left-0 h-full bg-smarters-purple w-0"></div>
                    </div>
                </div>
                <span id="player-time-duration">00:00</span>
            </div>

            <div class="flex items-center justify-between">
                <div class="flex gap-4">
                    <button id="player-settings-btn" class="text-white hover:text-smarters-purple relative">
                        <i class="fas fa-cog text-xl"></i>
                        <div id="player-settings-menu" class="hidden absolute bottom-full left-0 mb-2 bg-black/90 border border-white/10 rounded-lg p-2 min-w-[100px]">
                             <div class="text-xs text-gray-400 mb-1 border-b border-white/10 pb-1">السرعة</div>
                             <div class="speed-opt p-2 hover:bg-white/10 rounded text-xs text-white cursor-pointer" data-speed="1.0">Normal</div>
                             <div class="speed-opt p-2 hover:bg-white/10 rounded text-xs text-white cursor-pointer" data-speed="1.5">1.5x</div>
                             <div class="speed-opt p-2 hover:bg-white/10 rounded text-xs text-white cursor-pointer" data-speed="2.0">2.0x</div>
                        </div>
                    </button>
                    <button id="player-pip-btn" class="text-white hover:text-smarters-purple hidden md:block"><i class="fas fa-clone text-xl"></i></button>
                </div>

                                <div class="flex items-center gap-4 md:gap-6">
                    <button id="player-prev-btn" class="text-white hover:text-smarters-purple hidden"><i class="fas fa-step-backward text-xl"></i></button>
                    
                    <button id="player-seek-back-btn" class="text-white hover:text-smarters-purple flex flex-col items-center justify-center w-10 h-10 rounded-full hover:bg-white/10 transition">
                        <i class="fas fa-undo-alt text-lg"></i>
                        <span class="text-[9px] font-bold -mt-1">10</span>
                    </button>

                    <button id="player-play-pause-btn" class="w-14 h-14 rounded-full bg-white text-black flex items-center justify-center hover:scale-105 transition shadow-lg shadow-white/20">
                        <i class="fas fa-play text-2xl ml-1"></i>
                    </button>

                    <button id="player-seek-fwd-btn" class="text-white hover:text-smarters-purple flex flex-col items-center justify-center w-10 h-10 rounded-full hover:bg-white/10 transition">
                        <i class="fas fa-redo-alt text-lg"></i>
                        <span class="text-[9px] font-bold -mt-1">10</span>
                    </button>

                    <button id="player-next-btn" class="text-white hover:text-smarters-purple hidden"><i class="fas fa-step-forward text-xl"></i></button>
                </div>


                <div class="flex gap-4">
                    <button id="player-aspect-btn" class="text-white hover:text-smarters-purple"><i class="fas fa-expand text-xl"></i></button>
                    <button id="btn-open-external" class="text-white hover:text-smarters-purple"><i class="fas fa-external-link-alt text-xl"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>


    <!-- 5. Search Overlay -->
    <div id="search-results-overlay" class="fixed inset-0 z-[200] bg-black/90 backdrop-blur-xl hidden flex-col pt-10 px-4">
        <div class="max-w-4xl mx-auto w-full flex flex-col h-[80vh]">
            <div class="flex items-center gap-4 border-b border-white/10 pb-4">
                <button id="search-results-close-btn" class="text-white"><i class="fas fa-arrow-right text-xl"></i></button>
                <form action="#" onsubmit="return false;" autocomplete="off">
    <input 
        type="search" 
        name="unique_search_field_iptv" 
        id="global-search-input" 
        autocomplete="off" 
        aria-autocomplete="none"
        class="w-full bg-transparent text-white text-xl placeholder-gray-600 outline-none" 
        placeholder="ابحث عن فيلم، مسلسل...">
</form>
                <button id="global-search-clear" class="text-gray-500 hidden"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="search-results-loading" class="hidden text-center mt-10"><div class="spinner mx-auto"></div></div>
            
            <div id="search-results-list" class="flex-1 overflow-y-auto mt-4 space-y-2"></div>
        </div>
    </div>

    <!-- Loading & Error -->
    <div id="loading-view" class="view hidden fixed inset-0 z-[300] bg-black/80 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="spinner mb-4"></div>
            <p id="loading-message" class="text-white font-bold">جاري التحميل...</p>
        </div>
    </div>
    <div id="error-message" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-lg shadow-xl z-[400]"></div>
    

<div id="offline-modal" class="hidden fixed inset-0 z-[400] bg-black/90 flex flex-col items-center justify-center p-4">
    <div class="text-6xl text-gray-500 mb-4"><i class="fas fa-wifi"></i></div>
    <h2 class="text-2xl font-bold text-white mb-2">لا يوجد اتصال بالإنترنت</h2>
    <p class="text-gray-400 text-center">يرجى التحقق من الشبكة للمتابعة</p>
    <button onclick="window.location.reload()" class="mt-6 px-6 py-2 bg-smarters-purple rounded-lg text-white">إعادة المحاولة</button>
</div>




    <!-- Info Modal -->
        <div id="info-modal" class="hidden fixed inset-0 z-[250] bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-[#1a0b2e] border border-white/10 rounded-2xl w-full max-w-md overflow-hidden shadow-2xl relative">
            
            <div class="bg-gradient-to-r from-purple-900 to-blue-900 p-6 text-center relative">
                <button onclick="document.getElementById('info-modal').classList.add('hidden')" class="absolute top-4 left-4 w-8 h-8 rounded-full bg-black/20 hover:bg-white/20 text-white flex items-center justify-center transition">
                    <i class="fas fa-times"></i>
                </button>
                <div class="w-20 h-20 mx-auto bg-white/10 rounded-full flex items-center justify-center mb-3 border-2 border-white/20">
                    <i class="fas fa-user-circle text-5xl text-white"></i>
                </div>
                <h3 id="info-username-title" class="text-xl font-bold text-white">User Name</h3>
                <span id="info-status" class="text-xs font-bold px-2 py-1 rounded bg-green-500/20 text-green-400 mt-2 inline-block">Active</span>
            </div>

            <div class="p-6 space-y-4">
                
                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-yellow-500/10 flex items-center justify-center text-yellow-500"><i class="fas fa-hourglass-half"></i></div>
                        <div class="text-sm text-gray-400">تاريخ الانتهاء</div>
                    </div>
                    <div id="info-expiry" class="font-mono text-white font-bold text-sm">Loading...</div>
                </div>

                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-500"><i class="fas fa-calendar-alt"></i></div>
                        <div class="text-sm text-gray-400">تاريخ الإنشاء</div>
                    </div>
                    <div id="info-created" class="font-mono text-white font-bold text-sm">Loading...</div>
                </div>

                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-purple-500/10 flex items-center justify-center text-purple-500"><i class="fas fa-network-wired"></i></div>
                        <div class="text-sm text-gray-400">المتصلين / المسموح</div>
                    </div>
                    <div id="info-connections" class="font-mono text-white font-bold text-sm">0 / 1</div>
                </div>

                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gray-500/10 flex items-center justify-center text-gray-400"><i class="fas fa-server"></i></div>
                        <div class="text-sm text-gray-400">Host</div>
                    </div>
                    <div id="info-host" class="font-mono text-gray-300 text-xs truncate max-w-[150px]">...</div>
                </div>

            </div>

            <div class="p-4 bg-black/20 flex gap-3">
                <button onclick="renderAccountsList(); document.getElementById('accounts-modal').classList.remove('hidden'); document.getElementById('info-modal').classList.add('hidden');" class="flex-1 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-gray-300 text-sm transition">
                    <i class="fas fa-users"></i> تبديل الحساب
                </button>
            </div>
        </div>
    </div>


    <!-- Hidden triggers for original logic compatibility -->
    <div style="display: none;">
        <button id="theme-toggle-button"></button>
        <button id="theme-toggle-button-2"></button>
        <button id="info-button-main"></button>
        <button id="info-button-content"></button>
        <div id="install-prompt-container"></div><button id="install-btn"></button><button id="close-install-btn"></button>
    </div>

    <!-- ================= JAVASCRIPT LOGIC (RESTORED & ADAPTED) ================= -->
  
  <script>


    // تسجيل Service Worker
        if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // استخدام ./ مهم جداً في GitHub Pages
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker Registered! Scope:', reg.scope))
                .catch(err => console.error('Service Worker Failed:', err));
        });
    }


// --- دالة تنظيف الصفحة لمنع تداخل الطبقات ---
function clearContentArea() {
    // 1. إخفاء حاوية المسلسلات
    const seriesContainer = document.getElementById('series-info-container');
    if (seriesContainer) seriesContainer.classList.add('hidden');

    // 2. إخفاء حاوية الأفلام
    const movieContainer = document.getElementById('movie-info-container');
    if (movieContainer) movieContainer.classList.add('hidden');

    // 3. تنظيف شبكة البوسترات
    const grid = document.getElementById('content-grid');
    if (grid) grid.innerHTML = '';
    
    // 4. إخفاء القائمة الجانبية (سنظهرها فقط عند الحاجة)
    const sidebar = document.getElementById('category-sidebar');
    if (sidebar) sidebar.classList.add('hidden');
}



    document.addEventListener('DOMContentLoaded', () => {


// ==============================================================
// دالة الذهاب للقسم (المطورة: تجلب الاسم وتحدث السيدبار)
// ==============================================================
// ==============================================================
// دالة الذهاب للقسم (معدلة: تنظيف الواجهة فوراً لمنع التداخل)
// ==============================================================
// ==============================================================
// دالة الذهاب للقسم (النسخة النهائية: تمنع التداخل وتعالج الاسم)
// ==============================================================
// ==============================================================
// دالة الذهاب للقسم (معدلة: زر الرجوع يعود للرئيسية مباشرة)
// ==============================================================
window.goToCategoryFromDetails = async function(catId, type) {
    // 1. تنظيف شامل
    document.getElementById('series-info-container').classList.add('hidden');
    document.getElementById('movie-info-container').classList.add('hidden');
    document.getElementById('search-results-overlay').classList.add('hidden');
    
    // إظهار السايدبار وتفريغ الشبكة
    document.getElementById('category-sidebar').classList.remove('hidden'); 
    document.getElementById('content-grid').innerHTML = ''; 

    showView('loading'); 

    let action = '';
    let cacheKey = '';
    let sidebarType = '';

    if (type === 'series') {
        action = 'get_series_categories';
        cacheKey = 'allSeriesCategories';
        sidebarType = 'series_category';
    } else {
        action = 'get_vod_categories';
        cacheKey = 'allMovieCategories';
        sidebarType = 'vod_category';
    }

    if (!appCache[cacheKey] || appCache[cacheKey].length === 0) {
        try {
            const cats = await apiFetch(action, '', false); 
            appCache[cacheKey] = cats || [];
        } catch (e) { console.error("Failed to fetch categories"); }
    }

    const list = appCache[cacheKey] || [];
    const cat = list.find(c => c.category_id == catId);
    const catName = cat ? cat.category_name : "القسم المحدد";

    const titleEl = document.getElementById('content-title');
    if(titleEl) titleEl.textContent = catName;

    window.isDirectJump = true; 
    renderSidebar(list, sidebarType);

    const sidebarItems = document.querySelectorAll('#category-sidebar .cat-item');
    sidebarItems.forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-id') == catId) {
            item.classList.add('active');
            item.scrollIntoView({ block: 'center' });
        }
    });

    showView('content'); 

    setTimeout(async () => {
        await loadCategoryContent(catId, sidebarType);
    }, 50);

    // ============================================================
    // [الحل الجذري لمشكلة الرجوع]
    // بدلاً من إضافة الصفحة فوق المسلسل، نقوم بإعادة تعيين السجل
    // بحيث عند الضغط على رجوع، يذهب للمين منيو (Dashboard) مباشرة
    // ============================================================
    navigationStack = [{ view: 'mainMenu' }]; // تصفير السجل وإبقاء الرئيسية فقط
    
    navigationStack.push({
        view: 'content',
        title: catName,
        action: (type === 'series') ? 'get_series' : 'get_vod_streams',
        params: `&category_id=${catId}`,
        itemType: (type === 'series') ? 'series_list' : 'vod_stream'
    });
};





        // --- 1. إعدادات TMDB (تم نقلها هنا) ---
    const TMDB_API_KEY = '0a22e283abb463c59551311f3ec0bb08';
    const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
    const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w780'; 

            const TmdbService = {
        // دالة تنظيف ذكية تحافظ على الاسم وتحذف الرموز
        cleanName: (rawName) => {
            if (!rawName) return '';
            
            let name = rawName;

            // 1. استبدال الرموز (الأقواس، البايب، الشرطات) بمسافات بدلاً من حذف المحتوى
            // هذا يضمن بقاء الاسم حتى لو كان بين فواصل
            name = name.replace(/[\[\]\(\)\|\_\-\.\:]/g, ' ');

            // 2. حذف السنوات (مثل 2025, 2024, 1999) لأنها تشتت البحث
            name = name.replace(/\b\d{4}\b/g, '');

            // 3. حذف كلمات الجودة والكلمات الزائدة
            const removeWords = /\b(FHD|HD|SD|4K|8K|HEVC|H265|Bluray|WebDL|1080p|720p|HDR|Cam|TS|AR|EN|FR|TR|ES|RU|Series|Season|مترجم|مدبلج|حصري|مسلسل|كامل|جودة|عالية)\b/gi;
            name = name.replace(removeWords, '');

            // 4. تنظيف المسافات المزدوجة الناتجة عن الحذف
            return name.trim().replace(/\s+/g, ' ');
        },

        search: async (name, type = 'movie') => {
            if (!TMDB_API_KEY || TMDB_API_KEY.includes('ضع_مفتاح')) return null;
            
            const cleanName = TmdbService.cleanName(name);
            console.log(`Searching: ${cleanName} (Original: ${name})`); 
            
            const endpoint = type === 'series' ? 'search/tv' : 'search/movie';
            try {
                // المحاولة الأولى: بحث بالاسم النظيف واللغة العربية
                let url = `${TMDB_BASE_URL}/${endpoint}?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(cleanName)}&language=ar-SA&page=1`;
                let res = await fetch(url);
                let data = await res.json();
                
                // المحاولة الثانية: لو مفيش نتايج بالعربي، ابحث عالمياً
                if (!data.results || data.results.length === 0) {
                    url = `${TMDB_BASE_URL}/${endpoint}?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(cleanName)}&page=1`;
                    res = await fetch(url);
                    data = await res.json();
                }
                return data.results ? data.results[0] : null;
            } catch (e) { return null; }
        },

        getDetails: async (tmdbId, type = 'movie') => {
            if (!tmdbId) return null;
            const endpoint = type === 'series' ? 'tv' : 'movie';
            try {
                const url = `${TMDB_BASE_URL}/${endpoint}/${tmdbId}?api_key=${TMDB_API_KEY}&language=ar-SA&append_to_response=credits`;
                const res = await fetch(url);
                return await res.json();
            } catch (e) { return null; }
        }
    };




// دالة لمعرفة هل العنصر جديد أم لا (خلال آخر 5 أيام)
function isNewContent(dateString) {
    if (!dateString) return false;
    // صيغة التاريخ في السيرفرات عادة تكون Unix Timestamp أو نص
    // لو هي رقم (Timestamp):
    let itemDate = new Date(dateString * 1000); // لو جاية بالثواني
    
    // لو جاية نص (2025-10-20 ...)
    if (isNaN(itemDate.getTime())) { 
        itemDate = new Date(dateString);
    }

    const now = new Date();
    const diffTime = Math.abs(now - itemDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

    return diffDays <= 5; // يعتبر جديد لو مر عليه 5 أيام أو أقل
}





        // --- متغيرات عامة ---
        let currentCredentials = {};
        let apiBaseUrl = '';
        let hls = new Hls();
        const videoPlayer = document.getElementById('videoPlayer');
        let navigationStack = [];
        let currentUserInfo = null;
        let appCache = { 
            movieCategories: [], seriesCategories: [], liveCategories: [],
            allMovieCategories: [], allSeriesCategories: [], allLiveCategories: [] 
        };
        let appFavorites = [];
        let appHistory = [];
        let appProgress = []; // قائمة لحفظ التقدم

        const MAX_HISTORY = 15;
        const MAX_DASHBOARD_ITEMS = 50; // Increased for better view
             
 



        // --- تحميل البيانات الخلفية للبحث (ServerWorker Data) ---
        async function initSearchData() {
            // ننتظر قليلاً حتى يتم تسجيل الدخول
            if(!currentCredentials.user) return;

            try {
                // جلب الأقسام فقط لتسمية نتائج البحث (خفيف جداً)
                const [movCats, serCats, liveCats] = await Promise.all([
                    apiFetch('get_vod_categories', '', false),
                    apiFetch('get_series_categories', '', false),
                    apiFetch('get_live_categories', '', false)
                ]);
                
                if(movCats) appCache.allMovieCategories = movCats;
                if(serCats) appCache.allSeriesCategories = serCats;
                if(liveCats) appCache.allLiveCategories = liveCats;

            } catch(e) { console.log('Background data fetch error', e); }
        }






   // --- Sidebar Layout Logic (New) ---
        
        let activeCategoryType = ''; // 'live', 'movie', 'series'

                        function renderSidebar(categories, type) {
            const sidebar = document.getElementById('category-sidebar');
            sidebar.innerHTML = '';
            
            // إنشاء قائمة الفئات
            categories.forEach((cat, index) => {
                const el = document.createElement('div');
                // جعل أول عنصر نشطاً افتراضياً
                el.className = index === 0 ? 'cat-item active' : 'cat-item';
                
                // +++ هذا السطر الجديد مهم جداً لتحديد القسم لاحقاً +++
                el.setAttribute('data-id', cat.category_id); 
                
                // عرض اسم الفئة
                el.innerHTML = `<span>${cat.category_name}</span>`;
                
                el.onclick = () => {
                    setActiveSidebarItem(el);
                    loadCategoryContent(cat.category_id, type);
                };
                sidebar.appendChild(el);
            });

            // تحميل محتوى أول فئة تلقائياً إذا كنا في وضع التنقل العادي
            // سنلغي هذا الشرط في دالة الانتقال المباشر
            if (categories.length > 0 && !window.isDirectJump) {
                loadCategoryContent(categories[0].category_id, type);
            }
            window.isDirectJump = false; // إعادة تعيين المتغير
        }



        function setActiveSidebarItem(element) {
            const items = document.querySelectorAll('.cat-item');
            items.forEach(i => i.classList.remove('active'));
            element.classList.add('active');
        }

                        async function loadCategoryContent(categoryId, type) {
            const grid = document.getElementById('content-grid');
            const innerLoader = document.getElementById('inner-loader');
            
            grid.innerHTML = '';
            innerLoader.classList.remove('hidden');

            let action = '';
            let params = '';

            let cleanType = type.replace('_category', '');

            if (categoryId === 'all') {
                action = (cleanType === 'live') ? 'get_live_streams' : (cleanType === 'vod' || cleanType === 'movie') ? 'get_vod_streams' : 'get_series';
            } else {
                action = (cleanType === 'live') ? 'get_live_streams' : (cleanType === 'vod' || cleanType === 'movie') ? 'get_vod_streams' : 'get_series';
                params = `&category_id=${categoryId}`;
            }

            try {
                // ============================================================
                // [الحل الجذري]: تحديث الذاكرة لتعرف أننا نعرض "محتوى" الآن
                // ============================================================
                if(categoryId !== 'all' && navigationStack.length > 0) {
                     const currentState = navigationStack[navigationStack.length - 1];
                     
                     // 1. تحديث الأمر (Action) ليصبح جلب محتوى بدلاً من جلب أقسام
                     currentState.action = action; 
                     currentState.params = params;
                     
                     // 2. تحديث العنوان
                     const activeTitle = document.querySelector('.cat-item.active span')?.textContent;
                     if(activeTitle) {
                         currentState.title = activeTitle;
                         if(content.title) content.title.textContent = activeTitle;
                     }

                     // 3. تحديث نوع العرض (لضمان رسم بوسترات عند الرجوع)
                     if(cleanType === 'live') currentState.itemType = 'live_stream';
                     else if(cleanType === 'vod' || cleanType === 'movie') currentState.itemType = 'vod_stream';
                     else if(cleanType === 'series') currentState.itemType = 'series_list';
                }
                // ============================================================

                const url = `${apiBaseUrl}&action=${action}${params}`;
                const res = await fetch(url);
                const data = await res.json();
                
                let itemType = '';
                if(cleanType === 'live') itemType = 'live_stream';
                else if(cleanType === 'vod' || cleanType === 'movie') itemType = 'vod_stream';
                else if(cleanType === 'series') itemType = 'series_list';

                populateGrid(data, itemType);

            } catch(e) {
                console.error(e);
            } finally {
                innerLoader.classList.add('hidden');
            }
        }



        // --- متغيرات البحث المتطور (Web Worker) ---
        let searchWorker = null;
        const searchTriggers = {
            main: document.getElementById('search-trigger-main'),
            content: document.getElementById('search-trigger-content'),
        };
        const searchInput = document.getElementById('global-search-input');
        const searchClearBtn = document.getElementById('global-search-clear');
        const searchResultsOverlay = document.getElementById('search-results-overlay');
        const searchResultsList = document.getElementById('search-results-list');
        const searchResultsLoading = document.getElementById('search-results-loading');
        const searchResultsCloseBtn = document.getElementById('search-results-close-btn');

        // كود المعالج الخلفي (Worker)
        const workerScript = `
            self.onmessage = async function(e) {
                const { type, payload } = e.data;
                if (type === 'INIT_DATA') {
                    const { credentials } = payload;
                    const apiBase = \`\${credentials.host.replace(/\\/player_api\\.php$/, '')}/player_api.php?username=\${credentials.user}&password=\${credentials.pass}\`;
                    try {
                        const [movies, series, live] = await Promise.all([
                            fetch(\`\${apiBase}&action=get_vod_streams\`).then(r => r.json()).catch(() => []),
                            fetch(\`\${apiBase}&action=get_series\`).then(r => r.json()).catch(() => []),
                            fetch(\`\${apiBase}&action=get_live_streams\`).then(r => r.json()).catch(() => [])
                        ]);
                        self.allData = {
                            movies: movies.map(i => ({ ...i, type: 'vod_stream' })),
                            series: series.map(i => ({ ...i, type: 'series_list' })),
                            live: live.map(i => ({ ...i, type: 'live_stream' }))
                        };
                        self.postMessage({ type: 'DATA_READY' });
                    } catch (err) { self.postMessage({ type: 'ERROR', message: err.message }); }
                }
                if (type === 'SEARCH') {
                    const query = payload.query.toLowerCase();
                    if (!self.allData) { self.postMessage({ type: 'SEARCH_RESULTS', results: [] }); return; }
                    const limit = 50; 
                    let results = [];
                    const filterList = (list) => {
                        for (let item of list) {
                            if (results.length >= limit) break;
                            if (item.name && item.name.toLowerCase().includes(query)) results.push(item);
                        }
                    };
                    filterList(self.allData.series || []);
                    if (results.length < limit) filterList(self.allData.movies || []);
                    if (results.length < limit) filterList(self.allData.live || []);
                    self.postMessage({ type: 'SEARCH_RESULTS', results: results });
                }
            };
        `;

        // --- جلب عناصر الواجهة ---
        const views = {
            login: document.getElementById('login-view'),
            loading: document.getElementById('loading-view'),
            mainMenu: document.getElementById('main-menu-view'),
            content: document.getElementById('content-view'),
            player: document.getElementById('player-view')
        };
        const content = {
            title: document.getElementById('content-title'),
            grid: document.getElementById('content-grid'),
            seriesContainer: document.getElementById('series-info-container')
        };
        const errorBox = document.getElementById('error-message');
        const infoModal = document.getElementById('info-modal');
        const loadingMessage = document.getElementById('loading-message');

        // --- متغيرات المشغل ---
        const playerControls = document.querySelector('.player-controls-container');
        const playerLoadingSpinner = document.getElementById('player-loading-spinner');
        
        let controlsTimeout;
        let currentStreamInfo = { url: null, type: null, item: null, episodeList: [], episodeIndex: -1 };

        // --- LocalStorage ---
              // --- إدارة الحسابات والتخزين المعزول ---
        let accounts = []; // قائمة الحسابات
        let currentAccountId = null; // معرف الحساب الحالي

        function loadAccounts() {
            try {
                accounts = JSON.parse(localStorage.getItem('iptv_accounts_list')) || [];
            } catch (e) { accounts = []; }
        }

        function saveAccounts() {
            localStorage.setItem('iptv_accounts_list', JSON.stringify(accounts));
        }

        // توليد مفتاح تخزين خاص بالحساب الحالي (سر العزل)
        function getStorageKey(key) {
            if (!currentAccountId) return key; // fallback
            return `acc_${currentAccountId}_${key}`;
        }

        // دوال التخزين المحدثة (تستخدم المفتاح المعزول)
        function getLocalStorage(key, defaultValue = []) {
            try { 
                const scopedKey = getStorageKey(key);
                return JSON.parse(localStorage.getItem(scopedKey)) || defaultValue; 
            } catch (e) { return defaultValue; }
        }

        function setLocalStorage(key, value) { 
            const scopedKey = getStorageKey(key);
            localStorage.setItem(scopedKey, JSON.stringify(value)); 
        }
        
        function loadLocalData() {
            // تحميل البيانات الخاصة بالحساب الحالي فقط
            appFavorites = getLocalStorage('favorites', []);
            appHistory = getLocalStorage('history', []);
            appProgress = getLocalStorage('progress', []);
        }

        // تحديث دوال الحفظ لاستخدام المفاتيح المبسطة (سيتم دمجها مع ID الحساب تلقائياً)
        // ملاحظة: قمت بتغيير المفاتيح هنا لتكون أقصر، لأن getStorageKey سيضيف البادئة
        // لذا سنعدل استدعاءات setLocalStorage في باقي الكود


        // --- View Management ---
        function showView(viewId, message = 'جاري التحميل...') {
            if (loadingMessage) loadingMessage.textContent = message;
            Object.values(views).forEach(v => v.classList.add('hidden'));
            
            if (viewId === 'login') views.login.classList.remove('hidden');
            else if (viewId === 'loading') views.loading.classList.remove('hidden');
            else if (viewId === 'mainMenu') views.mainMenu.classList.remove('hidden');
            else if (viewId === 'content') views.content.classList.remove('hidden');
            else if (viewId === 'player') views.player.classList.remove('hidden');

            // إخفاء المودال
            if (infoModal) infoModal.classList.add('hidden');
        }
        
        function showError(message) {
            if (!errorBox) return;
            errorBox.textContent = message;
            errorBox.classList.remove('hidden');
            setTimeout(() => { errorBox.classList.add('hidden'); }, 3000);
        }

        // --- Dashboard Builder (Smarters Style) ---
        function createHorizontalSection(id, title, items, itemType) {
            if(!items || items.length === 0) return document.createElement('div');
            
            const section = document.createElement('div');
            section.className = 'mb-6';
            section.innerHTML = `<h3 class="text-xl font-bold text-white mb-3 px-2 border-r-4 border-smarters-purple mr-2">${title}</h3>`;
            
            const scrollContainer = document.createElement('div');
            scrollContainer.className = 'horizontal-scroll-container flex gap-4 overflow-x-auto pb-4';

            items.forEach(item => {
                const title = item.name || item.category_name;
                const img = item.cover || item.stream_icon || '';
                const id = item.stream_id || item.series_id;
                const type = itemType || item.type;
                
                const card = document.createElement('div');
                card.className = 'poster-card flex-shrink-0 w-32 md:w-40 cursor-pointer group bg-gray-800 rounded-lg overflow-hidden relative';
                card.innerHTML = `
                    ${img && img !== 'N/A' ? `<img src="${img}" class="w-full h-full object-cover group-hover:scale-110 transition duration-300" loading="lazy">` : 
                    `<div class="w-full h-full flex items-center justify-center bg-gray-700 text-gray-500"><i class="fas fa-image text-3xl"></i></div>`}
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex flex-col justify-end p-2">
                        <div class="text-white text-xs font-bold truncate">${title}</div>
                        <button class="fav-btn mt-2 text-white/70 hover:text-red-500"><i class="fas ${isFavorite(id) ? 'fa-heart text-red-500' : 'fa-heart'}"></i></button>
                    </div>
                `;
                card.onclick = () => { item.type = type; onItemClick(item); };
                card.querySelector('.fav-btn').onclick = (e) => { e.stopPropagation(); toggleFavorite(item, card.querySelector('.fav-btn i')); };
                scrollContainer.appendChild(card);
            });
            section.appendChild(scrollContainer);
            return section;
        }

                function loadDashboard() {
    // تم تفريغ الدالة تماماً لكي لا تعرض أي أقسام في الصفحة الرئيسية
    const container = document.getElementById('dashboard-container');
    if (container) container.innerHTML = ''; 
}


                               // --- متغيرات القوائم الافتراضية (Virtual Scroll) ---
        let vsData = [];      // البيانات الكاملة
        let vsType = '';      // نوع البيانات
        let vsContainer = null; // حاوية السكرول
        let vsGrid = null;      // شبكة العرض
        let vsItemHeight = 0;   // ارتفاع العنصر الواحد
        let vsColumns = 0;      // عدد الأعمدة في الصف
        let vsScrollTimeout;    // لتحسين الأداء

        // --- دالة populateGrid الجديدة (مع Virtual Scroll) ---
        function populateGrid(items, type) {
            // ============================================================
            // [التصحيح الهام]: إخفاء أي تفاصيل مفتوحة (أفلام/مسلسلات)
            // ============================================================
            document.getElementById('series-info-container').classList.add('hidden');
            document.getElementById('movie-info-container').classList.add('hidden');
            // ============================================================
            
            // 2. إعداد المتغيرات
            content.grid.innerHTML = '';
            vsGrid = content.grid;
            vsContainer = document.getElementById('content-container');
            
            // إظهار السايدبار (لأننا في وضع التصفح)
            const sidebar = document.getElementById('category-sidebar');
            if(sidebar) sidebar.classList.remove('hidden');

            // حفظ البيانات لاستخدامها في السكرول
            vsData = items || [];
            vsType = type;

            // كشف نوع العناصر (كما كان في الكود الأصلي)
            let isCategory = false;
            if (vsData.length > 0) {
                const first = vsData[0];
                if (first.series_id || first.stream_id) { isCategory = false; } 
                else if (first.category_name || (first.category_id && !first.cover && !first.stream_icon)) {
                    isCategory = true;
                    if (!vsType.includes('category')) {
                        const t = content.title.textContent;
                        if (t.includes('بث') || t.includes('Live')) vsType = 'live_category';
                        else if (t.includes('أفلام') || t.includes('Movies')) vsType = 'vod_category';
                        else vsType = 'series_category';
                    }
                }
            }
            // تحديث النوع النهائي للحفظ
            if (isCategory || (vsType.includes('category') && !vsData[0]?.series_id)) {
                 // في حال المجلدات (Categories) عادة تكون قليلة، نعرضها مباشرة بدون Virtualization لتجنب مشاكل التصميم
                 // أو يمكنك تطبيقها، لكن هنا سنفصل العرض للحفاظ على تصميم المجلدات المختلف
                 renderAllItemsStatic(vsData, vsType);
                 // إزالة مستمع السكرول إذا كنا في وضع المجلدات
                 vsContainer.onscroll = null; 
            } else {
                // --- تطبيق الـ Virtual Scroll للمحتوى (أفلام/مسلسلات/قنوات) ---
                
                // 1. ضبط كلاس الشبكة (كما كان)
                vsGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-3 content-start';
                
                // 2. تصفير السكرول للأعلى
                vsContainer.scrollTop = 0;

                // 3. حساب القياسات وبدء العرض
                if (vsData.length > 0) {
                    calculateMetricsAndRender();
                    // إضافة مستمع السكرول
                    vsContainer.onscroll = () => {
                        window.requestAnimationFrame(renderVirtualChunk);
                    };
                    // إضافة مستمع لتغيير حجم الشاشة (لإعادة حساب الأعمدة)
                    window.addEventListener('resize', calculateMetricsAndRender);
                }
            }
        }


        // --- دوال Virtual Scroll المساعدة ---

        // دالة لعرض المجلدات بالطريقة العادية (لأن عددها قليل وتصميمها مختلف)
        function renderAllItemsStatic(items, type) {
            content.grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3';
            vsGrid.style.paddingTop = '0px';
            vsGrid.style.height = 'auto';
            
            items.forEach(item => {
                const el = createItemElement(item, type, true);
                content.grid.appendChild(el);
            });
        }

        // حساب ارتفاع العنصر وعدد الأعمدة
        function calculateMetricsAndRender() {
            if(!vsData.length) return;

            // 1. رسم عنصر واحد وهمي لقياس أبعاده
            const tempItem = vsData[0];
            const tempEl = createItemElement(tempItem, vsType, false);
            tempEl.style.visibility = 'hidden';
            vsGrid.appendChild(tempEl);

            // 2. القياس
            vsItemHeight = tempEl.offsetHeight; // ارتفاع الكارت
            // حساب المسافة (Gap) تقريباً (الافتراضي في Tailwind gap-3 هو 12px)
            const gap = 12; 
            vsItemHeight += gap; 
            
            // حساب عدد الأعمدة بناء على عرض الحاوية وعرض العنصر
            const containerWidth = vsGrid.clientWidth;
            const itemWidth = tempEl.offsetWidth + gap;
            vsColumns = Math.floor(containerWidth / itemWidth);
            if(vsColumns < 2) vsColumns = 2; // أقل شيء عمودين (حسب تصميم الموبايل)

            // 3. تنظيف العنصر الوهمي
            vsGrid.innerHTML = '';
            
            // 4. استدعاء الرسم
            renderVirtualChunk();
        }

        // دالة الرسم الجزئي (Core Logic)
        function renderVirtualChunk() {
            if(!vsData.length || vsColumns === 0) return;

            const scrollTop = vsContainer.scrollTop;
            const containerHeight = vsContainer.clientHeight;
            
            // حساب إجمالي الصفوف والارتفاع الكلي
            const totalRows = Math.ceil(vsData.length / vsColumns);
            const totalHeight = totalRows * vsItemHeight;
            
            // ضبط ارتفاع الحاوية الكلي (ليظهر السكرول بار بحجمه الحقيقي)
            vsGrid.style.height = `${totalHeight}px`;
            vsGrid.style.position = 'relative'; // مهم للتموضع

            // تحديد مجال الرؤية (Buffer)
            let startRow = Math.floor(scrollTop / vsItemHeight);
            let endRow = Math.floor((scrollTop + containerHeight) / vsItemHeight);

            // إضافة هامش أمان (Buffer) لعدم ظهور مناطق بيضاء أثناء السكرول السريع
            startRow = Math.max(0, startRow - 2);
            endRow = Math.min(totalRows, endRow + 4);

            const startIndex = startRow * vsColumns;
            const endIndex = Math.min((endRow + 1) * vsColumns, vsData.length);

            // تفريغ الشبكة وإعادة رسم العناصر المرئية فقط
            vsGrid.innerHTML = '';

            // إنشاء العناصر المرئية
            for (let i = startIndex; i < endIndex; i++) {
                const item = vsData[i];
                const el = createItemElement(item, vsType, false);
                
                // تموضع مطلق (Absolute Positioning) للعنصر داخل الشبكة
                // هذه الطريقة الأفضل للحفاظ على الأداء بدلاً من Padding
                el.style.position = 'absolute';
                
                // حساب الموقع (RTL or LTR handled by CSS Grid usually, but manual positioning needs care)
                // للتبسيط وللحفاظ على Grid Layout سنستخدم طريقة Padding-Top للحاوية
                // لكن الطريقة الأفضل مع Grid هي استخدام عنصر واحد دافع (Spacer)
            }
            
            // --- تصحيح: استخدام طريقة Spacer بدلاً من Absolute للحفاظ على Grid ---
            // الطريقة السابقة Absolute تعقد الأمور مع Responsive. سنعود لطريقة الـ Spacer
            
            vsGrid.innerHTML = ''; // تفريغ
            
            // عنصر حشو علوي
            const topSpace = startRow * vsItemHeight;
            const topSpacer = document.createElement('div');
            topSpacer.style.height = `${topSpace}px`;
            topSpacer.style.gridColumn = `1 / -1`; // يأخذ عرض الصف بالكامل
            topSpacer.style.width = '100%';
            vsGrid.appendChild(topSpacer);

            // العناصر الفعلية
            for (let i = startIndex; i < endIndex; i++) {
                const item = vsData[i];
                const el = createItemElement(item, vsType, false);
                vsGrid.appendChild(el);
            }

            // عنصر حشو سفلي
            const bottomSpace = totalHeight - (topSpace + (endRow - startRow + 1) * vsItemHeight);
            if (bottomSpace > 0) {
                const bottomSpacer = document.createElement('div');
                bottomSpacer.style.height = `${Math.max(0, totalHeight - topSpace - ((endIndex - startIndex) / vsColumns * vsItemHeight))}px`; 
                // حساب دقيق للأسفل ليس ضرورياً جداً طالما الارتفاع الكلي مضبوط
                // لكن سنتركه بسيطاً:
                // نضبط الارتفاع الكلي للشبكة بدلاً من Spacer سفلي
            }
            // تعديل: الأفضل ضبط Grid Height الكلي وحساب Top Spacer فقط
            // ولكن بما أن Grid يوزع العناصر، الـ Spacer العلوي سيدفع العناصر للأسفل
            // والارتفاع الكلي للـ Grid سيضمن وجود السكرول.
        }

        // --- دالة إنشاء شكل العنصر (مفصولة للحفاظ على التصميم) ---
        function createItemElement(item, type, isCategory) {
            const el = document.createElement('div');
            
            if (isCategory) {
                // تصميم المجلدات
                el.className = 'bg-white/5 hover:bg-white/10 p-4 rounded-xl flex items-center gap-4 cursor-pointer border border-white/5 transition';
                const title = item.category_name || item.name || 'قسم';
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-full bg-smarters-purple/20 flex items-center justify-center text-smarters-purple"><i class="fas fa-folder"></i></div>
                    <div class="font-bold text-white truncate flex-1">${title}</div>
                    <i class="fas fa-chevron-left text-gray-500 text-xs"></i>
                `;
                el.onclick = () => { item.type = type; onItemClick(item); };
            } else {
                // تصميم البوسترات (نفس الكود القديم بالضبط)
                let displayName = item.name || item.title || item.category_name || ''; 
                if (!displayName || displayName === 'undefined') displayName = 'بدون عنوان';

                const img = item.stream_icon || item.cover || '';
                const hasImg = img && img !== 'N/A' && img.startsWith('http');
                const itemId = item.stream_id || item.series_id;

                // تحديد النوع
                let fixedType = type;
                if (fixedType.includes('category')) {
                    if (item.series_id) fixedType = 'series_list';
                    else if (item.stream_id && !item.container_extension) fixedType = 'live_stream';
                    else fixedType = 'vod_stream';
                }
                item.type = fixedType;

                // كود الشارة الجديد
                const isNew = isNewContent(item.added || item.last_modified);
                const newBadgeHTML = isNew ? 
                    `<div class="absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg z-30 animate-pulse pointer-events-none">جديد</div>` 
                    : '';

                el.className = 'poster-card cursor-pointer group bg-gray-900 rounded-lg overflow-hidden relative aspect-[2/3] border border-white/10';
                
                el.innerHTML = `
                    ${hasImg ? `<img src="${img}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500 opacity-90" loading="lazy">` : 
                    `<div class="w-full h-full flex flex-col items-center justify-center bg-gray-800 text-gray-500 p-2 text-center"><i class="fas fa-tv text-3xl mb-2"></i></div>`}
                    
                    ${newBadgeHTML}

                    <button class="fav-btn absolute top-2 left-2 z-20 w-8 h-8 rounded-full bg-black/60 backdrop-blur-sm flex items-center justify-center text-white shadow-md border border-white/10 hover:bg-red-600 hover:text-white transition">
                        <i class="fas ${isFavorite(itemId) ? 'fa-heart text-red-500' : 'fa-heart'} text-xs"></i>
                    </button>
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black via-black/90 to-transparent p-2 pt-6 z-10 flex flex-col justify-end min-h-[60px]">
                        <div class="text-white text-[11px] font-bold text-center leading-tight line-clamp-2" dir="auto">${displayName}</div>
                    </div>
                `;
                el.onclick = () => { onItemClick(item); };
                const favBtn = el.querySelector('.fav-btn');
                favBtn.onclick = (e) => { 
                    e.stopPropagation(); 
                    if(!item.cover && !item.stream_icon) item.cover = img; 
                    toggleFavorite(item, null); 
                    const icon = favBtn.querySelector('i');
                    if (isFavorite(itemId)) icon.classList.add('text-red-500');
                    else icon.classList.remove('text-red-500');
                };
            }
            return el;
        }



 


     

        // --- API & Login ---
        async function apiFetch(action, params = '', showLoader = true) {
            if(showLoader) showView('loading');
            const url = `${apiBaseUrl}&action=${action}${params}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if(showLoader) {
                     // Determine where to go back
                     const last = navigationStack[navigationStack.length-1];
                     if(last && last.view) showView(last.view); else showView('mainMenu');
                }
                return data;
            } catch(e) {
                showError('Connection Failed');
                if(action === '') showView('login');
                else if(navigationStack.length > 0) showView(navigationStack[navigationStack.length-1].view);
                return null;
            }
        }

                        async function handleLogin(host, user, pass, remember) {
            if(!host || !user || !pass) { showError('يرجى ملء جميع الحقول'); return; }
            
            if(!host.startsWith('http')) host = 'http://' + host;
            
            // 1. إعداد الاتصال
            currentCredentials = { host, user, pass };
            apiBaseUrl = `${host.replace(/\/player_api\.php$/, '')}/player_api.php?username=${user}&password=${pass}`;
            
            // 2. محاولة الاتصال
            const data = await apiFetch('', '', true);
            
            if(data && data.user_info && data.user_info.auth === 1) {
                // --- نجاح الدخول ---
                currentUserInfo = data.user_info;

                // 3. إدارة الحساب (إنشاء أو تحديث)
                loadAccounts();
                
                // البحث هل الحساب موجود مسبقاً
                let existingAccountIndex = accounts.findIndex(a => a.host === host && a.user === user);
                
                // --- [التصحيح هنا] ---
                // نتأكد أن العنصر موجود قبل قراءة قيمته لتجنب الخطأ
                const nameInputEl = document.getElementById('account-name');
                const customName = nameInputEl ? nameInputEl.value : '';
                
                let accName = customName || data.user_info.username;
                
                // توليد ID فريد إذا كان حساب جديد
                let accId = existingAccountIndex > -1 ? accounts[existingAccountIndex].id : Date.now().toString();

                const accountObj = {
                    id: accId,
                    // نستخدم المتغير الآمن customName بدلاً من القراءة المباشرة
                    name: (existingAccountIndex > -1 && !customName) ? accounts[existingAccountIndex].name : accName, 
                    host: host,
                    user: user,
                    pass: pass,
                    lastLogin: Date.now()
                };

                if (remember) {
                    if (existingAccountIndex > -1) {
                        accounts[existingAccountIndex] = accountObj; // تحديث
                    } else {
                        accounts.push(accountObj); // إضافة
                    }
                    saveAccounts();
                }

                // 4. تعيين الحساب الحالي
                currentAccountId = accId;
                if(remember) localStorage.setItem('iptv_last_active_id', accId);

                // 5. تحميل بيانات هذا الحساب
                loadLocalData(); 

                // 6. عرض الواجهة
                document.getElementById('user-display-name').textContent = accountObj.name;
                
                // تعبئة معلومات المودال
                const expDate = data.user_info.exp_date ? new Date(data.user_info.exp_date * 1000).toLocaleDateString('ar-EG') : 'غير محدود';
                const createdDate = data.user_info.created_at ? new Date(data.user_info.created_at * 1000).toLocaleDateString('ar-EG') : 'غير متوفر';
                const status = data.user_info.status;
                const activeCons = data.user_info.active_cons || 0;
                const maxCons = data.user_info.max_connections || 1;

                if(document.getElementById('info-username-title')) document.getElementById('info-username-title').textContent = user;
                if(document.getElementById('info-status')) {
                    document.getElementById('info-status').textContent = status;
                    if(status === 'Active') document.getElementById('info-status').className = "text-xs font-bold px-2 py-1 rounded bg-green-500/20 text-green-400 mt-2 inline-block";
                    else document.getElementById('info-status').className = "text-xs font-bold px-2 py-1 rounded bg-red-500/20 text-red-400 mt-2 inline-block";
                }
                
                if(document.getElementById('info-expiry')) document.getElementById('info-expiry').textContent = expDate;
                if(document.getElementById('info-created')) document.getElementById('info-created').textContent = createdDate;
                if(document.getElementById('info-connections')) document.getElementById('info-connections').textContent = `${activeCons} / ${maxCons}`;
                if(document.getElementById('info-host')) document.getElementById('info-host').textContent = host;

                showView('mainMenu');
                loadDashboard();
                loadCategories(); 
                
     // تشغيل أو تحديث Worker البحث
if(!searchWorker) {
    // إنشاء الوركر لأول مرة فقط
    const blob = new Blob([workerScript], {type: 'text/javascript'});
    searchWorker = new Worker(URL.createObjectURL(blob));
    searchWorker.onmessage = (e) => {
        if(e.data.type === 'SEARCH_RESULTS') renderSearchResults(e.data.results);
    };
}

// هام جداً: إرسال بيانات الحساب الجديد للوركر ليقوم بجلب المحتوى الخاص به
// وضعنا هذا السطر خارج الـ if ليعمل مع كل عملية تسجيل دخول أو تبديل حساب
searchWorker.postMessage({ type: 'INIT_DATA', payload: { credentials: currentCredentials } });


            } else {
                showError('فشل تسجيل الدخول: بيانات خاطئة');
                showView('login');
            }
        }

        async function loadCategories() {
             // Preload categories logic similar to original file
        }

        // --- Event Listeners ---
        document.getElementById('login-button').onclick = () => {
             handleLogin(
                 document.getElementById('host').value,
                 document.getElementById('username').value,
                 document.getElementById('password').value,
                 document.getElementById('remember-me').checked
             );
        };
        
        // --- تفعيل زر تسجيل الخروج ---
        if(document.getElementById('logout-button')) {
            document.getElementById('logout-button').onclick = () => {
                // 1. حذف البيانات المحفوظة من الذاكرة
                localStorage.removeItem('iptv_credentials');
                localStorage.removeItem('iptv_last_active_id'); // <--- هذا السطر هو الحل لمنع الدخول التلقائي
                
                // 2. تصفير المتغيرات الحالية
                currentCredentials = {};
                currentUserInfo = null;
                apiBaseUrl = '';
                
                // 3. عمل تحديث للصفحة
                window.location.reload();
            };
        }
                






        // XTREAM Toggle
        document.getElementById('toggle-xtream').onclick = () => {
            document.getElementById('xtream-container').classList.toggle('hidden');
        };
        document.getElementById('parse-link-button').onclick = () => {
            try {
                const url = new URL(document.getElementById('xtream-link').value);
                document.getElementById('host').value = url.origin;
                document.getElementById('username').value = url.searchParams.get('username');
                document.getElementById('password').value = url.searchParams.get('password');
            } catch(e) { alert('Invalid Link'); }
        };

                // Main Menu Buttons (Updated to use Sidebar)
                // --- دالة التنقل الموحدة (New Navigation Function) ---
        async function navigateTo(title, action, type) {
            // 1. تسجيل خطوة في تاريخ المتصفح
            history.pushState({ view: 'content' }, "", "");
            
            // 2. تحديث السجل الداخلي
            navigationStack.push({ view: 'content', title: title, action: action, type: type });
            content.title.textContent = title;
            
            showView('loading');
            
            // 3. جلب البيانات
            const data = await apiFetch(action, '', false);
            showView('content');
            
            if(data) renderSidebar(data, type);
        }

        // ربط الأزرار بالدالة الجديدة
        document.getElementById('btn-live').onclick = () => navigateTo('البث المباشر', 'get_live_categories', 'live_category');
        document.getElementById('btn-movies').onclick = () => navigateTo('الأفلام', 'get_vod_categories', 'vod_category');
        document.getElementById('btn-series').onclick = () => navigateTo('المسلسلات', 'get_series_categories', 'series_category');

        // Search
        const toggleSearch = () => {
            const overlay = document.getElementById('search-results-overlay');
            if(overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
                overlay.style.display = 'flex';
                document.getElementById('global-search-input').focus();
            } else {
                overlay.classList.add('hidden');
                overlay.style.display = 'none';
            }
        };
        document.getElementById('search-trigger-main').onclick = toggleSearch;
        document.getElementById('search-trigger-content').onclick = toggleSearch;
        document.getElementById('search-results-close-btn').onclick = toggleSearch;
        
        let searchTimeout;
        document.getElementById('global-search-input').oninput = (e) => {
            clearTimeout(searchTimeout);
            const q = e.target.value;
            if(q.length > 2) {
                document.getElementById('search-results-loading').classList.remove('hidden');
                searchTimeout = setTimeout(() => searchWorker.postMessage({type: 'SEARCH', payload: {query: q}}), 500);
            }
        };


        // دالة مساعدة لجلب اسم القسم من الكاش (مثل الكود القديم)
        function getCategoryName(item, type) {
            let list = [];
            if(type === 'vod_stream') list = appCache.allMovieCategories || [];
            else if(type === 'series_list') list = appCache.allSeriesCategories || [];
            else if(type === 'live_stream') list = appCache.allLiveCategories || [];
            
            const cat = list.find(c => c.category_id == item.category_id);
            return cat ? cat.category_name : type; // إذا لم يجد الاسم يعيد النوع
        }




                function renderSearchResults(results) {
            const list = document.getElementById('search-results-list');
            document.getElementById('search-results-loading').classList.add('hidden');
            list.innerHTML = '';

            if (!results || results.length === 0) {
                list.innerHTML = '<div class="p-4 text-center text-gray-400">لا توجد نتائج مطابقة.</div>';
                return;
            }

            results.forEach(item => {
                const el = document.createElement('div');
                // تنسيق العنصر ليكون مثل الكود القديم لكن بتصميم Smarters
                el.className = 'flex items-center gap-4 p-3 hover:bg-white/10 rounded-lg cursor-pointer border-b border-white/5 transition duration-200 group';
                
                // 1. تحديد الصورة والأيقونة
                let imageUrl = item.stream_icon || item.cover || '';
                if (imageUrl && !imageUrl.startsWith('http')) imageUrl = ''; // تجاهل الروابط الفاسدة
                
                let placeholderIcon = 'fa-film';
                let typeLabel = 'فيلم';
                
                if (item.type === 'series_list') {
                    placeholderIcon = 'fa-tv'; // أيقونة المسلسلات
                    typeLabel = 'مسلسل';
                } else if (item.type === 'live_stream') {
                    placeholderIcon = 'fa-broadcast-tower'; // أيقونة البث
                    typeLabel = 'بث مباشر';
                }

                // 2. جلب اسم القسم
                const catName = getCategoryName(item, item.type);

                // 3. بناء HTML العنصر (صورة + نص)
                el.innerHTML = `
                    <div class="relative w-12 h-16 flex-shrink-0 bg-gray-800 rounded overflow-hidden border border-white/10">
                        <img src="${imageUrl}" class="w-full h-full object-cover group-hover:scale-110 transition duration-300" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="absolute inset-0 flex items-center justify-center bg-gray-900 text-gray-500" style="display: ${imageUrl ? 'none' : 'flex'}">
                            <i class="fas ${placeholderIcon}"></i>
                        </div>
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <div class="font-bold text-white text-sm truncate group-hover:text-smarters-blue transition">${item.name}</div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-gray-400 truncate max-w-[70%]">${catName}</span>
                            <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded text-gray-300 border border-white/5">${typeLabel}</span>
                        </div>
                    </div>
                `;
                
                el.onclick = () => { 
                    toggleSearch(); // إغلاق البحث
                    onItemClick(item); // فتح العنصر
                };
                list.appendChild(el);
            });
        }

// دالة مساعدة للتحميل
function triggerDownload(url) {
    // استخدام cordova.InAppBrowser هو الحل الأكيد للتحميل
    if (typeof cordova !== 'undefined' && cordova.InAppBrowser) {
        cordova.InAppBrowser.open(url, '_system');
    } else {
        window.open(url, '_system');
    }
}




        // --- دالة عرض صفحة تفاصيل الفيلم (معدلة لإيقاف السكرول الافتراضي) ---
    // --- دالة عرض صفحة تفاصيل الفيلم (مصححة لإيقاف التداخل تماماً) ---
    async function showMovieInfoPage(item) {
        // 1. إيقاف Virtual Scroll فوراً (هذا السطر هو الحل الجذري)
        if (vsContainer) vsContainer.onscroll = null; 
        
        // 2. تنظيف الشبكة وتصفير أبعادها (لإخفاء القائمة الرئيسية)
        if (vsGrid) {
            vsGrid.innerHTML = '';
            vsGrid.style.height = 'auto';      // مهم جداً: إلغاء الارتفاع الوهمي
            vsGrid.style.paddingTop = '0px';   // مهم جداً: إلغاء الحشو
        }
        
        // تنظيف شامل إضافي (لضمان اختفاء كل شيء آخر)
        clearContentArea();

        // 3. إظهار حاوية الفيلم فقط
        const movieContainer = document.getElementById('movie-info-container');
        if(movieContainer) movieContainer.classList.remove('hidden');

        // إخفاء القائمة الجانبية (لأننا في صفحة تفاصيل كاملة)
        const sidebar = document.getElementById('category-sidebar');
        if(sidebar) sidebar.classList.add('hidden');

        // --- بداية تعيين البيانات (كما هي في كودك السابق) ---
        const titleEl = document.getElementById('movie-title-text');
        const posterEl = document.getElementById('movie-poster');
        const descEl = document.getElementById('movie-desc');
        const backdropEl = document.getElementById('movie-backdrop'); 
        const metaEl = document.getElementById('movie-meta');
        const castEl = document.getElementById('movie-cast');

        titleEl.textContent = item.name;
        posterEl.src = item.stream_icon || item.cover || 'https://via.placeholder.com/300x450?text=No+Image';
        descEl.textContent = item.plot || item.description || 'جاري جلب تفاصيل إضافية...';
        
        if(backdropEl) backdropEl.style.backgroundImage = 'none';
        metaEl.innerHTML = ''; 
        castEl.innerHTML = ''; 

        // الأزرار
        const btnsContainer = document.getElementById('btn-play-movie-tmdb').parentElement;
        btnsContainer.innerHTML = `
            <button id="btn-play-movie-tmdb" class="bg-smarters-purple hover:bg-purple-600 text-white px-8 py-3 rounded-xl font-bold text-lg transition flex items-center gap-2 shadow-lg shadow-purple-900/50">
                <i class="fas fa-play"></i> مشاهدة الآن
            </button>
            <button id="btn-download-movie" class="bg-green-600/80 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-bold transition border border-white/10 flex items-center gap-2">
                <i class="fas fa-download"></i> تحميل
            </button>
            <button id="btn-fav-movie-tmdb" class="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-xl font-bold transition border border-white/10">
                <i class="far fa-heart"></i>
            </button>
        `;

        // تفعيل زر التشغيل
        document.getElementById('btn-play-movie-tmdb').onclick = () => {
             let streamType = 'movie';
             let ext = item.container_extension || 'mp4';
             let cleanHost = currentCredentials.host.replace('https://', 'http://');
             if (!cleanHost.startsWith('http')) cleanHost = 'http://' + cleanHost;
             let url = `${cleanHost}/${streamType}/${currentCredentials.user}/${currentCredentials.pass}/${item.stream_id}.${ext}`;
             playStream(url, 'vod', item);
        };

        // تفعيل زر التحميل
        document.getElementById('btn-download-movie').onclick = async () => {
             let streamType = 'movie';
             let ext = item.container_extension || 'mp4';
             let cleanHost = currentCredentials.host.replace('https://', 'http://');
             if (!cleanHost.startsWith('http')) cleanHost = 'http://' + cleanHost;
             let url = `${cleanHost}/${streamType}/${currentCredentials.user}/${currentCredentials.pass}/${item.stream_id}.${ext}`;
             triggerDownload(url);

        };

        // تفعيل زر المفضلة
        const favBtn = document.getElementById('btn-fav-movie-tmdb');
        const updateFavIcon = () => {
             favBtn.innerHTML = isFavorite(item.stream_id) ? '<i class="fas fa-heart text-red-500"></i>' : '<i class="far fa-heart"></i>';
        };
        updateFavIcon();
        favBtn.onclick = () => { toggleFavorite(item, null); updateFavIcon(); };

        // جلب بيانات TMDB (الصور والممثلين)
        const tmdbResult = await TmdbService.search(item.name, 'movie');
        if (tmdbResult) {
            const details = await TmdbService.getDetails(tmdbResult.id, 'movie');
            if (details) {
                if (details.poster_path) posterEl.src = TMDB_IMAGE_BASE + details.poster_path;
                if (details.backdrop_path && backdropEl) backdropEl.style.backgroundImage = `url(${TMDB_IMAGE_BASE + details.backdrop_path})`;
                if (details.overview && details.overview.length > 0) descEl.textContent = details.overview;

                // جلب اسم القسم للفيلم (لزر الانتقال للقسم)
                let catName = getCategoryName(item, 'vod_stream');
                if (catName === 'vod_stream' || catName === 'movie') {
                    const foundCat = (appCache.allMovieCategories || []).find(c => c.category_id == item.category_id);
                    if (foundCat) catName = foundCat.category_name;
                }

                metaEl.innerHTML = `
                    <button onclick="window.goToCategoryFromDetails('${item.category_id}', 'movie')" class="bg-smarters-purple hover:bg-purple-600 text-white px-3 py-1 rounded-lg border border-white/10 transition text-xs flex items-center gap-1 cursor-pointer">
                        <i class="fas fa-folder-open"></i> ${catName}
                    </button>

                    <span class="bg-yellow-500/20 text-yellow-500 px-3 py-1 rounded-lg border border-yellow-500/20"><i class="fas fa-star mr-1"></i> ${details.vote_average ? details.vote_average.toFixed(1) : 'N/A'}</span>
                    <span class="bg-blue-500/20 text-blue-400 px-3 py-1 rounded-lg border border-blue-500/20"><i class="fas fa-calendar mr-1"></i> ${details.release_date ? details.release_date.split('-')[0] : 'N/A'}</span>
                    <span class="bg-white/10 text-gray-300 px-3 py-1 rounded-lg border border-white/10">${details.original_language ? details.original_language.toUpperCase() : 'EN'}</span>
                `;

                if (details.credits && details.credits.cast && details.credits.cast.length > 0) {
                    const castHtml = details.credits.cast.slice(0, 10).map(actor => {
                        const noImage = './assets/images/profile.png'; 
                        const actorImage = actor.profile_path ? (TMDB_IMAGE_BASE + actor.profile_path) : noImage;
                        return `
                        <div class="flex flex-col items-center min-w-[70px]">
                            <div class="w-14 h-14 rounded-full overflow-hidden border-2 border-white/10 shadow-lg mb-2 bg-gray-800 flex items-center justify-center">
                                <img src="${actorImage}" class="w-full h-full object-cover" onerror="this.src='${noImage}'">
                            </div>
                            <span class="text-[10px] text-gray-400 text-center leading-tight w-full truncate">${actor.name}</span>
                        </div>`;
                    }).join('');
                    
                    castEl.innerHTML = `
                        <h3 class="text-white font-bold mb-3 border-b border-white/10 pb-2 block w-full">طاقم التمثيل</h3>
                        <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                            ${castHtml}
                        </div>
                    `;
                }
            }
        }
    }

// --- دالة جديدة: الذهاب للقسم من صفحة التفاصيل ---
function goToCategoryFromDetails(catId, type) {
    // 1. تحديد القائمة المناسبة للبحث عن الاسم
    let list = [];
    let targetType = '';
    
    if (type === 'series') {
        list = appCache.allSeriesCategories || [];
        targetType = 'series_category';
    } else {
        list = appCache.allMovieCategories || [];
        targetType = 'vod_category';
    }

    // 2. البحث عن القسم
    const cat = list.find(c => c.category_id == catId);
    
    if (cat) {
        // 3. محاكاة ضغطة على مجلد القسم
        const categoryItem = {
            category_id: cat.category_id,
            category_name: cat.category_name,
            type: targetType
        };
        // نغلق البحث لو مفتوح
        document.getElementById('search-results-overlay').classList.add('hidden');
        // نستدعي دالة النقر الرئيسية
        onItemClick(categoryItem);
    } else {
        // لو القسم غير موجود في الكاش (نادر الحدوث)
        alert('بيانات القسم غير متوفرة حالياً');
    }
}


        // --- دالة عرض تفاصيل المسلسل (معدلة لإيقاف السكرول الافتراضي) ---
        async function populateSeriesInfo(data, item) {
        // 1. إيقاف السكرول الافتراضي (كما كان)
        if (vsContainer) vsContainer.onscroll = null;
        if (vsGrid) {
            vsGrid.innerHTML = '';
            vsGrid.style.height = 'auto';
            vsGrid.style.paddingTop = '0px';
        }

        // ============================================================
        // [التصحيح الهام]: إخفاء حاوية الأفلام والسيدبار فوراً لمنع التداخل
        // ============================================================
        document.getElementById('movie-info-container').classList.add('hidden'); 
        document.getElementById('category-sidebar').classList.add('hidden');
        // ============================================================

        // إظهار حاوية المسلسل
        content.seriesContainer.classList.remove('hidden');
        
        const info = data.info || data;
document.getElementById('content-title').textContent = info.name || item.name;
        
        // تعيين البيانات
        document.getElementById('series-title').textContent = info.name;
        document.getElementById('series-plot').textContent = info.plot || 'لا يوجد وصف متاح.';
        document.getElementById('series-cover').src = info.cover || item.cover || 'https://via.placeholder.com/300x450';
        
        // تفريغ العناصر القديمة
        const backdropEl = document.getElementById('series-backdrop');
        const metaEl = document.getElementById('series-meta');
        const castEl = document.getElementById('series-cast');
        
        if(backdropEl) backdropEl.style.backgroundImage = 'none';
        if(metaEl) metaEl.innerHTML = '';
        if(castEl) castEl.innerHTML = '';

        // معالجة زر المفضلة
        const favBtn = document.getElementById('series-fav-btn');
        const updateFavState = () => {
            if (isFavorite(item.series_id)) {
                favBtn.innerHTML = '<i class="fas fa-heart text-red-500"></i> <span class="text-red-500">مضاف للمفضلة</span>';
                favBtn.classList.remove('bg-white/10');
                favBtn.classList.add('bg-red-500/10');
            } else {
                favBtn.innerHTML = '<i class="far fa-heart"></i> <span>إضافة للمفضلة</span>';
                favBtn.classList.remove('bg-red-500/10');
                favBtn.classList.add('bg-white/10');
            }
        };
        updateFavState();
        favBtn.onclick = () => {
            const itemToSave = { ...item, name: info.name, cover: info.cover, type: 'series' };
            toggleFavorite(itemToSave, null); 
            updateFavState(); 
        };

        // جلب بيانات TMDB والزر الخاص بالقسم
        TmdbService.search(info.name, 'series').then(async (tmdbResult) => {
            if (tmdbResult) {
                const details = await TmdbService.getDetails(tmdbResult.id, 'series');
                if (details) {
                    if (details.poster_path) document.getElementById('series-cover').src = TMDB_IMAGE_BASE + details.poster_path;
                    if (details.backdrop_path && backdropEl) backdropEl.style.backgroundImage = `url(${TMDB_IMAGE_BASE + details.backdrop_path})`;
                    if (details.overview && details.overview.length > 0) document.getElementById('series-plot').textContent = details.overview;

                    if(metaEl) {
                        // كود زر القسم الذي أضفناه سابقاً
                        let catName = getCategoryName(item, 'series_list');
                        if (catName === 'series_list' || catName === 'series') {
                            const foundCat = (appCache.allSeriesCategories || []).find(c => c.category_id == item.category_id);
                            if (foundCat) catName = foundCat.category_name;
                        }

                        metaEl.innerHTML = `
                            <button onclick="window.goToCategoryFromDetails('${item.category_id}', 'series')" class="bg-smarters-purple hover:bg-purple-600 text-white px-3 py-1 rounded-lg border border-white/10 transition text-xs flex items-center gap-1 cursor-pointer">
                                <i class="fas fa-folder-open"></i> ${catName}
                            </button>
                            <span class="bg-yellow-500/20 text-yellow-500 px-3 py-1 rounded-lg border border-yellow-500/20"><i class="fas fa-star mr-1"></i> ${details.vote_average.toFixed(1)}</span>
                            <span class="bg-blue-500/20 text-blue-400 px-3 py-1 rounded-lg border border-blue-500/20"><i class="fas fa-calendar mr-1"></i> ${details.first_air_date ? details.first_air_date.split('-')[0] : 'N/A'}</span>
                            <span class="bg-purple-500/20 text-purple-300 px-3 py-1 rounded-lg border border-purple-500/20"><i class="fas fa-tv mr-1"></i> ${details.number_of_seasons} مواسم</span>
                        `;
                    }

                    if (details.credits && details.credits.cast && castEl) {
                        const castHtml = details.credits.cast.slice(0, 10).map(actor => `
                            <div class="flex flex-col items-center min-w-[60px]">
                                <img src="${actor.profile_path ? TMDB_IMAGE_BASE + actor.profile_path : './assets/images/profile.png'}" 
                                     class="w-12 h-12 rounded-full object-cover border-2 border-white/10 shadow-lg mb-1">
                                <span class="text-[9px] text-gray-400 text-center leading-tight w-full truncate">${actor.name}</span>
                            </div>
                        `).join('');
                        castEl.innerHTML = `<div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 mt-4 border-t border-white/10 pt-4">${castHtml}</div>`;
                    }
                }
            }
        });

        // معالجة المواسم والحلقات
        const seasons = data.seasons || [];
        const episodes = data.episodes || {};
        const tabsContainer = document.getElementById('season-tabs');
        const epGrid = document.getElementById('episodes-grid');
        tabsContainer.innerHTML = '';
        
        let seasonKeys = Array.isArray(episodes) ? [] : Object.keys(episodes);

        seasonKeys.forEach((key, idx) => {
            const btn = document.createElement('button');
            btn.className = `px-5 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition border ${idx===0 ? 'bg-smarters-purple text-white border-smarters-purple' : 'bg-black/40 text-gray-400 border-white/10 hover:bg-white/10'}`;
            btn.textContent = `موسم ${key}`;
            
            btn.onclick = () => {
                Array.from(tabsContainer.children).forEach(c => 
                    c.className = c.className.replace('bg-smarters-purple text-white border-smarters-purple', 'bg-black/40 text-gray-400 border-white/10')
                );
                btn.className = 'px-5 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition border bg-smarters-purple text-white border-smarters-purple';
                renderEpisodes(episodes[key]);
            };
            tabsContainer.appendChild(btn);
        });
        
        if(seasonKeys.length > 0) renderEpisodes(episodes[seasonKeys[0]]);

        function renderEpisodes(eps) {
            epGrid.innerHTML = '';
            eps.forEach(ep => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-4 p-3 bg-white/5 rounded-lg hover:bg-white/10 cursor-pointer transition border border-white/5 group relative';
                
                let streamUrl = `${currentCredentials.host}/series/${currentCredentials.user}/${currentCredentials.pass}/${ep.id}.${ep.container_extension}`;
                streamUrl = streamUrl.replace('https://', 'http://');
                if (!streamUrl.startsWith('http')) streamUrl = 'http://' + streamUrl;

                row.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-xs font-bold text-gray-300">${ep.episode_num}</div>
                    <div class="flex-1 font-medium text-white truncate pr-2">${ep.title}</div>
                    <button class="download-btn w-8 h-8 rounded-full bg-white/5 hover:bg-green-600 hover:text-white text-gray-400 flex items-center justify-center transition z-10" title="تحميل">
                        <i class="fas fa-download text-xs"></i>
                    </button>
                    <i class="fas fa-play-circle text-smarters-purple text-xl group-hover:scale-110 transition"></i>
                `;

                const dlBtn = row.querySelector('.download-btn');
                dlBtn.onclick = async (e) => { e.stopPropagation(); triggerDownload(streamUrl); };

                row.onclick = () => {
                    const epData = { ...ep, stream_id: ep.id, series_id: item.series_id, name: `${info.name} - ${ep.title}`, cover: info.cover, type: 'series' };
                    playStream(streamUrl, 'series', epData, eps, eps.indexOf(ep));
                };
                epGrid.appendChild(row);
            });
        }
    }





                   async function onItemClick(item) {
             const type = item.type || ''; 
             
             // --- [تحديث هام: التشغيل المباشر لاستكمال المشاهدة] ---
             // إذا كان العنصر يحتوي على وقت محفوظ، نشغله فوراً بدون فتح صفحة التفاصيل
             // هذا يحل مشكلة الرجوع مرتين ومشكلة عدم عمل حلقات المسلسلات
             if (item.savedTime && item.savedTime > 0) {
                 
                 // 1. تحديد نوع الرابط بدقة
                 let streamType = 'movie'; // افتراضي
                 
                 if (item.series_id) { 
                     streamType = 'series'; // لو فيه رقم مسلسل، يبقى ده حلقة
                 } else if (item.type === 'live' || item.type === 'live_stream') {
                     streamType = 'live';
                 }

                 // 2. تحديد الامتداد والآيدي
                 let ext = item.container_extension || 'mp4';
                 let id = item.stream_id; // في الاستكمال، الـ stream_id هو رقم الحلقة أو الفيلم

                 // 3. بناء الرابط
                 let cleanHost = currentCredentials.host.replace('https://', 'http://');
                 if (!cleanHost.startsWith('http')) cleanHost = 'http://' + cleanHost;

                 let url = `${cleanHost}/${streamType}/${currentCredentials.user}/${currentCredentials.pass}/${id}.${ext}`;
                 
                 console.log("Direct Play (Resume):", url);
                 
                 // 4. التشغيل فوراً والخروج من الدالة
                 playStream(url, streamType, item);
                 return; // <--- هذا يمنع فتح صفحة المعلومات
             }
             // -------------------------------------------------------

             // 1. عند فتح مجلد (Category)
             if(type.includes('category')) {
                 history.pushState({ view: 'content' }, "", "");
                 
                 const action = type === 'live_category' ? 'get_live_streams' : (type === 'vod_category' ? 'get_vod_streams' : 'get_series');
                 
                 let nextType = '';
                 if (type === 'series_category') nextType = 'series_list'; 
                 else if (type === 'vod_category') nextType = 'vod_stream';
                 else nextType = 'live_stream';
                 
                 navigationStack.push({ 
                     view: 'content', 
                     title: item.category_name, 
                     action: action, 
                     params: `&category_id=${item.category_id}`,
                     itemType: nextType
                 });

                 content.title.textContent = item.category_name;
                 
                 const data = await apiFetch(action, `&category_id=${item.category_id}`, false); 
                 if(data) populateGrid(data, nextType);

             // 2. عند فتح مسلسل (تصفح الحلقات)
             } else if ((type === 'series_list' || type === 'series') && !item.container_extension) {
                 history.pushState({ view: 'content' }, "", "");
                 navigationStack.push({ 
                     view: 'content', 
                     title: item.name, 
                     isSeriesInfo: true,
                     seriesId: item.series_id, // حفظنا الايدي
                     savedItem: item           // حفظنا بيانات البوستر والاسم
                 });
     
                 const data = await apiFetch('get_series_info', `&series_id=${item.series_id}`);
                 if(data) populateSeriesInfo(data, item);

             // 3. عند تشغيل فيديو جديد (من القوائم العادية)
             } else {
                 let streamType = 'movie';
                 
                 if (type === 'live_stream' || type === 'live') {
                     streamType = 'live';
                     playDirectly(item, type); // البث المباشر
                 } 
                 else if (type === 'series' || item.series_id) {
                     // حلقة مسلسل من داخل القائمة
                     streamType = 'series';
                     // هنا نتركها كما هي لأنها تُعالج عادة داخل renderEpisodes
                 } else {
                     // فيلم: نفتح صفحة التفاصيل أولاً
                     history.pushState({ view: 'content' }, "", "");
                     navigationStack.push({ view: 'content', title: item.name, isMovieInfo: true });
                     showMovieInfoPage(item);
                 }
             }
        }


                        // دالة مساعدة لتشغيل البث المباشر (تم تصحيح الامتداد ليعمل البث)
        function playDirectly(item, type) {
             let streamType = 'live';
             // الخطأ كان هنا: تم تغيير m3u8 إلى ts لأن أغلب السيرفرات تعمل بـ ts
             let ext = item.container_extension || 'ts'; 
             let id = item.stream_id;
             
             let cleanHost = currentCredentials.host.replace('https://', 'http://');
             if (!cleanHost.startsWith('http')) cleanHost = 'http://' + cleanHost;
             
             let url = `${cleanHost}/${streamType}/${currentCredentials.user}/${currentCredentials.pass}/${id}.${ext}`;
             
             console.log("Playing Live URL:", url); 
             playStream(url, type, item);
        }




                        // ==========================================
        // منطق المشغل الاحترافي الجديد (Capacitor Optimized)
        // ==========================================

        let isPlayerLocked = false;
        let uiTimeout;

        // دوال مساعدة لـ Capacitor Plugins
        async function setScreenBrightness(val) {
            // val من 0.0 إلى 1.0
            if (window.Capacitor && Capacitor.Plugins.ScreenBrightness) {
                try {
                    await Capacitor.Plugins.ScreenBrightness.setBrightness({ brightness: val });
                } catch (e) { console.warn('Brightness plugin not active'); }
            }
        }

        async function getScreenBrightness() {
            if (window.Capacitor && Capacitor.Plugins.ScreenBrightness) {
                try {
                    const { brightness } = await Capacitor.Plugins.ScreenBrightness.getBrightness();
                    return brightness;
                } catch (e) { return 0.5; }
            }
            return 0.5;
        }

                            // دالة تهيئة المشغل (النسخة النهائية مع أزرار التقديم والتأخير)
        // استبدل دالة initPlayerAndControls بالكامل بهذا الكود
// =========================================================
// 2. كود دالة التحكمات الجديد (انسخ هذا بدلاً من القديم)
// =========================================================
function initPlayerAndControls() {
    const vPlayer = document.getElementById('videoPlayer');
    const playerUI = document.getElementById('player-ui');
    const touchArea = document.getElementById('gesture-area');
    const spinner = document.getElementById('player-loading-spinner');

    // =================================================
    // بداية كود السطوع والصوت (تمت استعادته)
    // =================================================
    
    // تعريف المتغيرات
    let touchStartY = 0;
    let touchStartX = 0;
    let isDragging = false;
    let startVal = 0; 
    let touchAction = ''; 
    const brightnessOverlay = document.getElementById('brightness-overlay');
    if(typeof window.currentBrightness === 'undefined') window.currentBrightness = 0; 

    // 1. عند بدء اللمس
    touchArea.addEventListener('touchstart', (e) => {
        // نتجاهل اللمس إذا كان المستخدم يضغط على شريط التقدم (لتجنب التداخل)
        if(e.target.closest('#player-progress-container')) return;

        touchStartY = e.touches[0].clientY;
        touchStartX = e.touches[0].clientX;
        isDragging = true;
        
        const screenWidth = window.innerWidth;
        
        // تحديد المنطقة (يمين أم يسار)
        if (touchStartX > screenWidth / 2) {
            touchAction = 'volume';
            startVal = vPlayer.volume;
            showCenterFeedback('volume', Math.round(startVal * 100));
        } else {
            touchAction = 'brightness';
            startVal = window.currentBrightness; 
            showCenterFeedback('brightness', Math.round((1 - startVal) * 100));
        }
    }, { passive: false });

    // 2. أثناء تحريك الإصبع
    touchArea.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        e.preventDefault(); // منع سكرول الصفحة
        
        const deltaY = touchStartY - e.touches[0].clientY;
        const screenHeight = window.innerHeight;
        const percentChange = deltaY / (screenHeight * 0.6); // حساسية اللمس

        if (touchAction === 'volume') {
            let newVol = startVal + percentChange;
            newVol = Math.min(Math.max(newVol, 0), 1);
            vPlayer.volume = newVol;
            updateCenterFeedback('volume', Math.round(newVol * 100));
        } else if (touchAction === 'brightness') {
            // في السطوع البرمجي: زيادة القيمة تعني تقليل opacity (زيادة السطوع)
            let change = percentChange * -1; 
            let newOpacity = startVal + change; 
            newOpacity = Math.min(Math.max(newOpacity, 0), 0.8); // أقصى عتامة 0.8
            
            window.currentBrightness = newOpacity;
            if(brightnessOverlay) brightnessOverlay.style.opacity = newOpacity;
            
            updateCenterFeedback('brightness', Math.round((1 - newOpacity) * 100));
        }
    }, { passive: false });

    // 3. عند رفع الإصبع
    touchArea.addEventListener('touchend', () => {
        isDragging = false;
        hideCenterFeedback();
    });

    // =================================================
    // نهاية كود السطوع والصوت
    // =================================================

    const playPauseBtn = document.getElementById('player-play-pause-btn');
    
    // --- حل مشكلة 3 و 4: السبينر وأيقونة التشغيل ---
    // نتأكد فوراً هل الفيديو يعمل أم لا ونضبط الشكل
    if (!vPlayer.paused) {
        playPauseBtn.innerHTML = '<i class="fas fa-pause text-2xl"></i>';
        spinner.style.display = 'none';
    } else {
        playPauseBtn.innerHTML = '<i class="fas fa-play text-2xl ml-1"></i>';
    }

    // تحديث الحالة عند حدوث أحداث الفيديو
    vPlayer.addEventListener('playing', () => {
        spinner.style.display = 'none';
        playPauseBtn.innerHTML = '<i class="fas fa-pause text-2xl"></i>';
    });
    vPlayer.addEventListener('waiting', () => {
        spinner.style.display = 'block';
    });
    vPlayer.addEventListener('pause', () => {
        playPauseBtn.innerHTML = '<i class="fas fa-play text-2xl ml-1"></i>';
    });

    // تشغيل وإيقاف الفيديو عند الضغط على الزر
    playPauseBtn.onclick = (e) => {
        e.stopPropagation();
        if (vPlayer.paused) vPlayer.play();
        else vPlayer.pause();
    };

    // --- حل مشكلة 1: أزرار التقديم والتأخير ---
    // زر تقديم 10 ثواني
    const seekFwdBtn = document.getElementById('player-seek-fwd-btn');
    if(seekFwdBtn) {
        seekFwdBtn.onclick = (e) => {
            e.stopPropagation();
            vPlayer.currentTime += 10;
            showSeekFeedback('forward'); // إظهار علامة +10s
        };
    }
    
    // زر تأخير 10 ثواني
    const seekBackBtn = document.getElementById('player-seek-back-btn');
    if(seekBackBtn) {
        seekBackBtn.onclick = (e) => {
            e.stopPropagation();
            vPlayer.currentTime -= 10;
            showSeekFeedback('rewind'); // إظهار علامة -10s
        };
    }

           // --- حل مشكلة المشغل الخارجي (نسخة نهائية) ---
    const extBtn = document.getElementById('btn-open-external');
    if(extBtn) {
        extBtn.onclick = (e) => {
            e.stopPropagation();
            
            // 1. التأكد من وجود رابط
            if(!currentStreamInfo || !currentStreamInfo.url) {
                showToast('لا يوجد رابط للتشغيل');
                return;
            }

            let streamUrl = currentStreamInfo.url.trim();
            // تنظيف الرابط
            if(streamUrl.startsWith('//')) streamUrl = 'https:' + streamUrl;

            // 2. فحص هل الجهاز أندرويد؟
            const isAndroid = /android/i.test(navigator.userAgent);

            if (isAndroid) {
                // استخراج البروتوكول (http أو https) والرابط بدون بروتوكول
                const scheme = streamUrl.startsWith('https') ? 'https' : 'http';
                const cleanUrl = streamUrl.replace(/^https?:\/\//, '');

                // بناء Intent مخصص للفيديو (VLC/MX Player)
                // الصيغة: intent://رابط#Intent;scheme=http;type=video/*;end;
                const intentUrl = `intent://${cleanUrl}#Intent;scheme=${scheme};type=video/*;action=android.intent.action.VIEW;end;`;
                
                // استخدام InAppBrowser لتنفيذ الأمر (System)
                if (typeof cordova !== 'undefined' && cordova.InAppBrowser) {
                    cordova.InAppBrowser.open(intentUrl, '_system');
                } else {
                    // محاولة بديلة
                    window.open(intentUrl, '_system');
                }
            } else {
                // للكمبيوتر أو الآيفون (فتح عادي)
                if (typeof cordova !== 'undefined' && cordova.InAppBrowser) {
                    cordova.InAppBrowser.open(streamUrl, '_system');
                } else {
                    window.open(streamUrl, '_system');
                }
            }
        };
    }


        // --- حل مشكلة 2: شريط التقدم (Scrubbing) ---
    const progressContainer = document.getElementById('player-progress-container');
    const progressFilled = document.getElementById('player-progress-filled');
    let isScrubbing = false;
    let lastScrubTime = 0; // متغير لحفظ الوقت أثناء السحب

    // تحديث الشريط أثناء تشغيل الفيديو (فقط لو المستخدم لا يسحب الشريط بيده)
    vPlayer.addEventListener('timeupdate', () => {
        if (!isScrubbing && !isNaN(vPlayer.duration)) {
            const pct = (vPlayer.currentTime / vPlayer.duration) * 100;
            progressFilled.style.width = `${pct}%`;
            document.getElementById('player-time-current').textContent = formatTime(vPlayer.currentTime);
            document.getElementById('player-time-duration').textContent = formatTime(vPlayer.duration);
            
            // حفظ التقدم
            if(currentStreamInfo.item) saveWatchProgress(currentStreamInfo.item, vPlayer.currentTime, vPlayer.duration);
        }
    });

    // دالة حساب الوقت بناء على مكان اللمس
    const scrub = (e) => {
        const rect = progressContainer.getBoundingClientRect();
        
        // جلب مكان الإصبع بدقة (يدعم اللمس والماوس)
        let clientX;
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
        } else if (e.changedTouches && e.changedTouches.length > 0) {
            // هذا الجزء مهم جداً لحدث touchend
            clientX = e.changedTouches[0].clientX;
        } else {
            clientX = e.clientX;
        }

        const pos = (clientX - rect.left) / rect.width;
        let ratio = Math.min(Math.max(pos, 0), 1);
        const newTime = ratio * vPlayer.duration;
        
        // تحديث الشكل فورياً
        progressFilled.style.width = `${ratio * 100}%`;
        document.getElementById('player-time-current').textContent = formatTime(newTime);
        
        return newTime;
    };

    const startScrub = (e) => { 
        isScrubbing = true; 
        lastScrubTime = scrub(e); // حفظ الوقت المبدئي
    };
    
    const moveScrub = (e) => { 
        if(isScrubbing) {
            // نمنع تحديد النص أثناء السحب
            if(e.preventDefault) e.preventDefault(); 
            lastScrubTime = scrub(e); // تحديث الوقت المحفوظ باستمرار أثناء الحركة
        }
    };
    
    const endScrub = (e) => {
        if(isScrubbing) {
            isScrubbing = false;
            // استخدام آخر وقت تم حسابه بدلاً من محاولة الحساب مرة أخرى
            if(!isNaN(lastScrubTime)) {
                vPlayer.currentTime = lastScrubTime;
            }
        }
    };

    // إضافة المستمعين (Listeners)
    progressContainer.addEventListener('mousedown', startScrub);
    document.addEventListener('mousemove', moveScrub); 
    document.addEventListener('mouseup', endScrub);
    
    // إضافة Touch Listeners (مهم جداً استخدام passive: false لمنع مشاكل السكرول)
    progressContainer.addEventListener('touchstart', startScrub, {passive: false});
    document.addEventListener('touchmove', moveScrub, {passive: false});
    document.addEventListener('touchend', endScrub);
    
    // النقر البسيط
    progressContainer.onclick = (e) => {
        vPlayer.currentTime = scrub(e);
    };


    // --- التحكم في إظهار واجهة المشغل ---
    let uiTimeout;
    function showUI() {
        playerUI.style.opacity = '1';
        playerUI.style.pointerEvents = 'auto';
        clearTimeout(uiTimeout);
        if (!vPlayer.paused) uiTimeout = setTimeout(hideUI, 4000);
    }
    function hideUI() {
        if (vPlayer.paused) return; // لا تخفي الواجهة لو الفيديو واقف
        playerUI.style.opacity = '0';
        playerUI.style.pointerEvents = 'none';
        // إخفاء قائمة الإعدادات لو مفتوحة
        const settingsMenu = document.getElementById('player-settings-menu');
        if(settingsMenu) settingsMenu.classList.add('hidden');
    }
    
    // النقر على الشاشة يظهر/يخفي الواجهة
    touchArea.onclick = () => { if (playerUI.style.opacity === '1') hideUI(); else showUI(); };
    
    // إظهار الواجهة عند البدء
    showUI();

    // --- باقي الأزرار (PIP، السرعة، أبعاد الشاشة) ---
    // (هذه الأجزاء كانت تعمل جيداً وسنتركها كما هي لكن نضمن وجودها)
    
    // زر PIP
    const pipBtn = document.getElementById('player-pip-btn');
    if(pipBtn) pipBtn.onclick = async (e) => {
        e.stopPropagation();
        try {
            if (document.pictureInPictureElement) await document.exitPictureInPicture();
            else await vPlayer.requestPictureInPicture();
        } catch(err) {}
    };

             // --- حل مشكلة 1: زر التكبير وتدوير الشاشة (المنطق الجديد) ---
    const aspectBtn = document.getElementById('player-aspect-btn');
    let aspectModes = ['contain', 'cover', 'fill']; 
    let currentAspect = 0;

    if(aspectBtn) aspectBtn.onclick = async (e) => {
        e.stopPropagation();
        
        // 1. التحقق: هل نحن في وضع ملء الشاشة؟
        const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement;

        if (!isFullscreen) {
            // إذا لم يكن بملء الشاشة -> قم بتدوير الشاشة وعمل Fullscreen فوراً
            const playerView = document.getElementById('player-view');
            try {
                if (playerView.requestFullscreen) await playerView.requestFullscreen();
                else if (playerView.webkitRequestFullscreen) await playerView.webkitRequestFullscreen();
                
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock('landscape');
                }
                showToast('تم تدوير الشاشة');
            } catch(err) { console.log(err); }
        } else {
            // إذا كنا بالفعل بملء الشاشة -> قم بتغيير أبعاد الفيديو (Zoom/Fit)
            currentAspect = (currentAspect + 1) % aspectModes.length;
            videoPlayer.style.objectFit = aspectModes[currentAspect];
            
            let modeName = aspectModes[currentAspect] === 'contain' ? 'كامل' : 
                           aspectModes[currentAspect] === 'cover' ? 'تكيبر (Zoom)' : 'ملء (Stretch)';
            showToast(`الوضع: ${modeName}`);
        }
    };

    // قائمة السرعة
    const settingsBtn = document.getElementById('player-settings-btn');
    const settingsMenu = document.getElementById('player-settings-menu');
    if(settingsBtn) settingsBtn.onclick = (e) => {
        e.stopPropagation();
        settingsMenu.classList.toggle('hidden');
    };
    document.querySelectorAll('.speed-opt').forEach(opt => {
        opt.onclick = (e) => {
            e.stopPropagation();
            videoPlayer.playbackRate = parseFloat(e.target.dataset.speed);
            settingsMenu.classList.add('hidden');
            showToast(`السرعة: ${e.target.dataset.speed}x`);
        };
    });

    // أزرار الحلقات (التالي والسابق)
    const nextBtn = document.getElementById('player-next-btn');
    const prevBtn = document.getElementById('player-prev-btn');
    if(nextBtn) nextBtn.classList.add('hidden');
    if(prevBtn) prevBtn.classList.add('hidden');

    if (currentStreamInfo.type === 'series' && currentStreamInfo.episodeList.length > 0) {
        const idx = currentStreamInfo.currentIndex;
        const list = currentStreamInfo.episodeList;
        if (idx < list.length - 1) {
            nextBtn.classList.remove('hidden');
            nextBtn.onclick = (e) => { e.stopPropagation(); switchEpisode(list[idx + 1], idx + 1); };
        }
        if (idx > 0) {
            prevBtn.classList.remove('hidden');
            prevBtn.onclick = (e) => { e.stopPropagation(); switchEpisode(list[idx - 1], idx - 1); };
        }
    }
}





// دالة مساعدة لتبديل الحلقات
function switchEpisode(ep, newIndex) {
    let streamUrl = `${currentCredentials.host}/series/${currentCredentials.user}/${currentCredentials.pass}/${ep.id}.${ep.container_extension}`;
    streamUrl = streamUrl.replace('https://', 'http://');
    if (!streamUrl.startsWith('http')) streamUrl = 'http://' + streamUrl;

    const newItem = { 
        ...ep, 
        stream_id: ep.id, 
        series_id: currentStreamInfo.item.series_id, 
        name: `${currentStreamInfo.item.name.split('-')[0]} - ${ep.title}`, // المحافظة على اسم المسلسل
        cover: currentStreamInfo.item.cover, 
        type: 'series' 
    };

    // إعادة تشغيل الفيديو بالبيانات الجديدة
    playStream(streamUrl, 'series', newItem, currentStreamInfo.episodeList, newIndex);
}

// دوال مساعدة للواجهة (Feedback)
function showCenterFeedback(type, value) {
    const box = document.getElementById('center-feedback');
    const icon = document.getElementById('feedback-icon');
    const text = document.getElementById('feedback-text');
    const bar = document.getElementById('feedback-bar');
    
    box.style.opacity = '1';
    
    if (type === 'volume') {
        icon.className = value === 0 ? 'fas fa-volume-mute text-4xl text-white mb-3' : 'fas fa-volume-up text-4xl text-white mb-3';
    } else {
        icon.className = 'fas fa-sun text-4xl text-white mb-3';
    }
    
    text.textContent = value;
    bar.style.width = `${value}%`;
}

function updateCenterFeedback(type, value) {
    const text = document.getElementById('feedback-text');
    const bar = document.getElementById('feedback-bar');
    text.textContent = value;
    bar.style.width = `${value}%`;
    
    // تحديث الأيقونة إذا صار mute
    if (type === 'volume') {
        const icon = document.getElementById('feedback-icon');
        icon.className = value === 0 ? 'fas fa-volume-mute text-4xl text-white mb-3' : 'fas fa-volume-up text-4xl text-white mb-3';
    }
}

function hideCenterFeedback() {
    document.getElementById('center-feedback').style.opacity = '0';
}

function showSeekFeedback(type) {
    const el = type === 'forward' ? document.getElementById('seek-feedback-right') : document.getElementById('seek-feedback-left');
    el.style.opacity = '1';
    setTimeout(() => el.style.opacity = '0', 500);
}

function showToast(msg) {
    // دالة بسيطة لعرض رسالة صغيرة
    const toast = document.createElement('div');
    toast.className = 'fixed top-10 left-1/2 -translate-x-1/2 bg-black/70 text-white px-4 py-2 rounded-full z-[100000] text-sm font-bold';
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// تنسيق الوقت
function formatTime(s) {
    if(isNaN(s)) return "00:00";
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60);
    return `${m}:${sec < 10 ? '0'+sec : sec}`;
}



          

       // ==========================================
// منطق المشغل المطور (PWA Optimized)
// ==========================================

let wakeLock = null;
currentStreamInfo = { 
    url: null, 
    type: null, 
    item: null, 
    episodeList: [], 
    currentIndex: -1 
};

// دالة التشغيل الرئيسية
// =========================================================
// 1. كود دالة التشغيل الجديد (انسخ هذا بدلاً من القديم)
// =========================================================
// =========================================================
// 1. كود دالة التشغيل (المعدل لحل مشكلة زر الرجوع)
// =========================================================
playStream = async function(url, type, itemToSave = null, episodeList = [], episodeIndex = -1) {
    const isAlreadyInPlayer = navigationStack.length > 0 && navigationStack[navigationStack.length - 1].view === 'player';
    await window.stopStream();
    
    if (!isAlreadyInPlayer) {
        history.pushState({ view: 'player' }, "", "");
        navigationStack.push({ view: 'player' });
    }
    
    showView('player');
    const vPlayer = document.getElementById('videoPlayer');

    // --- كود التدوير الإجباري (يعتمد على cordova.js) ---
    try {
        if (window.screen.orientation && window.screen.orientation.lock) {
            window.screen.orientation.lock('landscape').catch(err => console.log(err));
        } else if (window.screen.lockOrientation) {
            window.screen.lockOrientation('landscape');
        }
    } catch (e) { console.log("Rotation Error:", e); }

    // منع انطفاء الشاشة
    try { if (window.plugins && window.plugins.insomnia) window.plugins.insomnia.keepAwake(); } catch(e){}

    currentStreamInfo = { url, type, item: itemToSave, episodeList: episodeList || [], currentIndex: episodeIndex };
    
    if(itemToSave) {
        document.getElementById('player-overlay-title').textContent = itemToSave.name;
        addToHistory(itemToSave);
    }

    if (Hls.isSupported() && (url.includes('.m3u8') || type === 'live' || type === 'live_stream')) {
        if(window.hls) window.hls.destroy();
        var hlsConfig = { debug: false, enableWorker: true, lowLatencyMode: true, backBufferLength: 90, xhrSetup: function (xhr, url) { xhr.withCredentials = false; } };
        window.hls = new Hls(hlsConfig);
        window.hls.loadSource(url);
        window.hls.attachMedia(vPlayer);
    } else {
        vPlayer.src = url;
    }
    
    vPlayer.load();
    let savedTime = getSavedTime(itemToSave);
    if (savedTime > 10 && !type.includes('live')) vPlayer.currentTime = savedTime;
    
    try { await vPlayer.play(); } catch(e) {}
    
    const isLive = (type === 'live' || type === 'live_stream');
    const progContainer = document.getElementById('player-progress-container');
    if(progContainer && progContainer.parentElement) progContainer.parentElement.style.visibility = isLive ? 'hidden' : 'visible';
    document.getElementById('player-time-duration').textContent = isLive ? "LIVE" : "00:00";

    initPlayerAndControls();
};







    // 4. دالة إيقاف الفيديو (المصححة لاستعادة القوائم)
            window.stopStream = async function() {
    const vPlayer = document.getElementById('videoPlayer');
    vPlayer.pause();
    vPlayer.removeAttribute('src');
    vPlayer.load();
    if(window.hls) { window.hls.destroy(); window.hls = null; }

    document.getElementById('player-view').classList.add('hidden');
    
    // فك قفل التدوير والعودة للوضع العمودي
    try {
        if (window.screen.orientation && window.screen.orientation.unlock) {
            window.screen.orientation.unlock();
        } else if (window.screen.unlockOrientation) {
            window.screen.unlockOrientation();
        }
    } catch(e) {}
    
    // السماح بانطفاء الشاشة مرة أخرى
    try { if (window.plugins && window.plugins.insomnia) window.plugins.insomnia.allowSleepAgain(); } catch(e){}
};



    
    // =========================================================
    // نهاية الكود الجديد
    // =========================================================

    // =========================================================
    // دالة معالجة زر الرجوع (النسخة النهائية لإصلاح البث المباشر)
    // =========================================================
        // =========================================================
    // دالة معالجة زر الرجوع (النسخة النهائية والشاملة للإصلاح)
    // =========================================================
    window.onpopstate = async function(event) {
        
        // 1. التعامل مع المشغل (الأولوية القصوى)
        const playerView = document.getElementById('player-view');
        if (!playerView.classList.contains('hidden')) {
            await window.stopStream();
            
            // إزالة حالة المشغل من السجل
            if (navigationStack.length > 0 && navigationStack[navigationStack.length - 1].view === 'player') {
                navigationStack.pop();
            }

            // استعادة الشاشة السابقة
            if (navigationStack.length > 0) {
                const prev = navigationStack[navigationStack.length - 1];
                showView(prev.view);
                if(prev.title && content.title) content.title.textContent = prev.title;

                // إصلاح خاص للبث المباشر عند الرجوع من المشغل
                if (prev.view === 'content' && !prev.isSeriesInfo && !prev.isMovieInfo) {
                    if (vsData && vsData.length > 0) {
                         setTimeout(() => { populateGrid(vsData, vsType); }, 100);
                    }
                }

            } else {
                showView('mainMenu');
            }
            return; // توقف هنا
        }

        // 2. التعامل مع التنقل العادي (بين الصفحات)
        if (navigationStack.length > 1) {
            navigationStack.pop(); // حذف الصفحة الحالية
            const prevState = navigationStack[navigationStack.length - 1]; // الصفحة السابقة
            
            if(prevState.title && content.title) content.title.textContent = prevState.title;

            // أ) حالة الرجوع لمسلسل (استعادة بيانات المسلسل)
            if(prevState.isSeriesInfo) {
                 content.grid.innerHTML = '';
                 document.getElementById('movie-info-container').classList.add('hidden');
                 
                 if (prevState.seriesId && prevState.savedItem) {
                     showView('loading');
                     const data = await apiFetch('get_series_info', `&series_id=${prevState.seriesId}`, false);
                     if(data) {
                         await populateSeriesInfo(data, prevState.savedItem);
                         showView('content');
                     } else {
                         showView('mainMenu');
                         navigationStack = [{ view: 'mainMenu' }];
                     }
                 } else {
                     if(content.seriesContainer) content.seriesContainer.classList.remove('hidden');
                 }

            // ب) حالة الرجوع لفيلم
            } else if (prevState.isMovieInfo) { 
                 content.grid.innerHTML = '';
                 if(document.getElementById('movie-info-container')) document.getElementById('movie-info-container').classList.remove('hidden');
                 if(content.seriesContainer) content.seriesContainer.classList.add('hidden');
                 const sidebar = document.getElementById('category-sidebar');
                 if(sidebar) sidebar.classList.add('hidden');
                 
            // ج) حالة الرجوع لقائمة (بث مباشر، أفلام، إلخ) - [هنا التعديل المهم]
            } else {
                 // تنظيف الحاويات
                 if(content.seriesContainer) content.seriesContainer.classList.add('hidden');
                 if(document.getElementById('movie-info-container')) document.getElementById('movie-info-container').classList.add('hidden');
                 
                 showView(prevState.view);

                 // ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                 // [الحل الجذري]: إعادة بناء الشبكة بالكامل لاستعادة السكرول والمقاسات
                 // هذا يحل مشكلة تداخل قنوات البث المباشر عند الرجوع من البحث
                 // ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                 if (vsData && vsData.length > 0) {
                     setTimeout(() => {
                        // نستخدم populateGrid بدلاً من calculateMetricsAndRender
                        // لأنها تعيد تفعيل مستمع السكرول وتعيد ضبط الارتفاعات
                        populateGrid(vsData, vsType);
                     }, 100);
                 }
                 // ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

                 // إذا كان هناك تحديث مطلوب من السيرفر (اختياري، سيقوم بتحديث الشبكة مرة أخرى)
                 if (prevState.view === 'content' && prevState.action) {
                     const data = await apiFetch(prevState.action, prevState.params || '', false);
                     if(data) populateGrid(data, prevState.itemType || 'vod_stream');
                 } else if (prevState.isLocal) {
                    if(prevState.title === 'المفضلة') openLocalList('المفضلة', appFavorites);
                    else if(prevState.title === 'سجل المشاهدة') openLocalList('سجل المشاهدة', appHistory);
                    else if(prevState.title === 'استكمال المشاهدة') openLocalList('استكمال المشاهدة', appProgress);
                 }
            }
        } else {
            // لو مفيش صفحات سابقة، ارجع للرئيسية
            showView('mainMenu');
            navigationStack = [{ view: 'mainMenu' }];
        }
    };




        // --- تحسين الساعة والتاريخ ---
        function updateClock() {
            const d = new Date();
            const timeEl = document.getElementById('header-time');
            const dateEl = document.getElementById('header-date');
            
            // 1. تحديث الوقت (تحديث فوري)
            if(timeEl) {
                timeEl.textContent = d.toLocaleTimeString('en-US', {
                    hour: '2-digit', 
                    minute:'2-digit', 
                    hour12: true 
                });
            }

            // 2. تحديث التاريخ (لحل مشكلة ...)
            if(dateEl) {
                // عرض التاريخ بتنسيق عربي جميل (مثال: الجمعة، ١٣ ديسمبر)
                dateEl.textContent = d.toLocaleDateString('ar-EG', {
                    weekday: 'long', 
                    day: 'numeric', 
                    month: 'short'
                });
            }
        }

        // استدعاء الدالة فوراً عند فتح الموقع (لحل مشكلة 00:00)
        updateClock();

        // تحديث كل ثانية لضمان الدقة
        setInterval(updateClock, 1000);




                // ==========================================
        // 1. دوال الذاكرة والمفضلة والسجل (تم تصحيحها لتعمل مع تعدد الحسابات)
        // ==========================================

        // ملاحظة: لقد قمنا بحذف دوال getLocalStorage و setLocalStorage من هنا 
        // لأننا قمنا بتعريفها مسبقاً في الأعلى لتدعم تعدد الحسابات (acc_id).
        // إعادة تعريفها هنا كان يسبب المشكلة.
        
        // تحميل البيانات عند البدء (تم التصحيح لاستخدام المفاتيح الموحدة)
        // هذه الدالة موجودة بالأعلى، ولكن سنبقي عليها هنا للتأكد من تحميل البيانات عند استدعاء الأزرار
        // شرط ألا نعيد تعريف دوال التخزين الأساسية.
        
        function refreshLocalData() {
            // نستخدم الدوال الذكية المعرفة في الأعلى
            appFavorites = getLocalStorage('favorites', []);
            appHistory = getLocalStorage('history', []);
            appProgress = getLocalStorage('progress', []); 
        }

        // التحقق هل العنصر في المفضلة؟
        function isFavorite(id) {
            if (!id) return false;
            return appFavorites.some(item => (item.stream_id == id || item.series_id == id));
        }

        // إضافة/حذف من المفضلة
        function toggleFavorite(item, btnElement) {
            if (!item || (!item.stream_id && !item.series_id)) return;
            const id = item.stream_id || item.series_id;
            const favIndex = appFavorites.findIndex(fav => (fav.stream_id == id || fav.series_id == id));
            
            if (favIndex > -1) {
                appFavorites.splice(favIndex, 1); // حذف
                if (btnElement) { btnElement.classList.remove('text-red-500'); }
            } else {
                appFavorites.unshift(item); // إضافة
                if (btnElement) { btnElement.classList.add('text-red-500'); }
            }
            // الحفظ باستخدام الدالة الذكية (ستضيف acc_id تلقائياً)
            setLocalStorage('favorites', appFavorites);
            
            // تحديث الواجهة إذا كنا في القائمة الرئيسية
            if (!views.mainMenu.classList.contains('hidden')) loadDashboard();
        }

        // إضافة للسجل (History)
        function addToHistory(item) {
            if (!item || (!item.stream_id && !item.series_id)) return;
            const id = item.stream_id || item.series_id;
            
            // حذف التكرار القديم لنفس العنصر
            appHistory = appHistory.filter(hist => {
                const histId = hist.stream_id || hist.series_id;
                return histId != id;
            });
            
            // إضافة الجديد في المقدمة
            appHistory.unshift(item);
            // الاحتفاظ بآخر 50 عنصر فقط
            appHistory = appHistory.slice(0, 50);
            
            setLocalStorage('history', appHistory);
        }


        // تحديث أزرار الرجوع اليدوية
        const pBackBtn = document.getElementById('player-back-button');
        if(pBackBtn) {
            const newPBackBtn = pBackBtn.cloneNode(true);
            pBackBtn.parentNode.replaceChild(newPBackBtn, pBackBtn);
            newPBackBtn.onclick = function() { window.history.back(); };
        }
        if(document.getElementById('back-button')) {
             document.getElementById('back-button').onclick = function() { window.history.back(); };
        }


        // ==========================================
        // 2. دوال عرض القوائم المحلية (المفضلة والسجل)
        // ==========================================

        function renderLocalSidebar(fullList) {
            const sidebar = document.getElementById('category-sidebar');
            sidebar.innerHTML = ''; 

            const localCategories = [
                { id: 'all', name: 'الكل' },
                { id: 'live', name: 'بث مباشر' },
                { id: 'movie', name: 'أفلام' },
                { id: 'series', name: 'مسلسلات' }
            ];

            localCategories.forEach((cat, index) => {
                const el = document.createElement('div');
                el.className = index === 0 ? 'cat-item active' : 'cat-item';
                
                // فلترة القائمة حسب النوع
                let filteredList = [];
                if (cat.id === 'all') filteredList = fullList;
                else if (cat.id === 'live') filteredList = fullList.filter(i => i.type === 'live_stream' || (i.stream_id && !i.container_extension));
                else if (cat.id === 'movie') filteredList = fullList.filter(i => i.type === 'vod_stream' || (i.stream_id && i.container_extension && !i.series_id));
                else if (cat.id === 'series') filteredList = fullList.filter(i => i.type === 'series' || i.series_id);

                el.innerHTML = `<span>${cat.name}</span> <span class="cat-count">${filteredList.length}</span>`;
                
                el.onclick = () => {
                    document.querySelectorAll('.cat-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                    populateGrid(filteredList, 'mixed');
                };
                sidebar.appendChild(el);
            });
        }

        function openLocalList(title, listData) {
            // تحديث البيانات قبل العرض للتأكد
            refreshLocalData();
            
            // إذا كانت القائمة المرسلة فارغة، نحاول جلبها من المتغيرات العامة المحدثة
            let dataToShow = listData;
            if (title === 'المفضلة') dataToShow = appFavorites;
            else if (title === 'سجل المشاهدة') dataToShow = appHistory;
            else if (title === 'استكمال المشاهدة') dataToShow = appProgress;

            if(!dataToShow || dataToShow.length === 0) {
                showError('القائمة فارغة حالياً');
                return;
            }
            
            history.pushState({ view: 'content' }, "", "");
            navigationStack.push({ view: 'content', title: title, isLocal: true });
            
            content.title.textContent = title;
            showView('content');
            renderLocalSidebar(dataToShow);
            populateGrid(dataToShow, 'mixed');
        }


        // ==========================================
        // 3. تفعيل أزرار الشاشة الرئيسية
        // ==========================================

        if(document.getElementById('btn-favorites-shortcut')) {
            document.getElementById('btn-favorites-shortcut').onclick = () => {
                refreshLocalData(); 
                openLocalList('المفضلة', appFavorites);
            };
        }

        if(document.getElementById('btn-history-shortcut')) {
            document.getElementById('btn-history-shortcut').onclick = () => {
                refreshLocalData();
                openLocalList('سجل المشاهدة', appHistory);
            };
        }
        
        // تفعيل زر الحساب
        if(document.getElementById('btn-settings-shortcut')) {
            document.getElementById('btn-settings-shortcut').onclick = () => {
                document.getElementById('info-modal').classList.remove('hidden');
            };
        }

        // تفعيل زر استكمال المشاهدة
        if(document.getElementById('btn-continue-shortcut')) {
            document.getElementById('btn-continue-shortcut').onclick = () => {
                refreshLocalData();
                // ترتيب حسب آخر مشاهدة
                appProgress.sort((a, b) => b.lastWatched - a.lastWatched);
                openLocalList('استكمال المشاهدة', appProgress);
            };
        }


        // دالة لحفظ التقدم (تسمى أثناء المشاهدة)
        function saveWatchProgress(item, currentTime, duration) {
            if (!item || (!item.stream_id && !item.series_id) || currentTime < 5) return;
            
            // إذا انتهى الفيديو تقريباً نحذفه من "استكمال المشاهدة"
            if (duration > 0 && (currentTime > duration - 30 || currentTime / duration > 0.95)) {
                removeProgress(item);
                return;
            }

            const id = item.stream_id || item.series_id;
            const existingIndex = appProgress.findIndex(p => {
                const pId = p.stream_id || p.series_id;
                return pId == id;
            });
            
            const progressItem = {
                ...item,
                savedTime: currentTime,
                totalDuration: duration,
                lastWatched: Date.now()
            };

            if (existingIndex > -1) {
                appProgress[existingIndex] = progressItem; // تحديث
            } else {
                appProgress.unshift(progressItem); // إضافة
            }
            
            setLocalStorage('progress', appProgress);
        }

        // دالة لجلب وقت التوقف المحفوظ
        function getSavedTime(item) {
            if (!item) return 0;
            const id = item.stream_id || item.series_id;
            // تأكد أن appProgress محملة
            if(!appProgress || appProgress.length === 0) appProgress = getLocalStorage('progress', []);
            
            const found = appProgress.find(p => {
                const pId = p.stream_id || p.series_id;
                return pId == id;
            });
            return found ? found.savedTime : 0;
        }

        // دالة لحذف التقدم (عند انتهاء الفيديو)
        function removeProgress(item) {
            const id = item.stream_id || item.series_id;
            appProgress = appProgress.filter(p => {
                const pId = p.stream_id || p.series_id;
                return pId != id;
            });
            // تصحيح المفتاح هنا ليصبح 'progress' بدلاً من 'iptv_progress'
            setLocalStorage('progress', appProgress);
        }


// دالة لجلب وقت التوقف المحفوظ
function getSavedTime(item) {
    if (!item) return 0;
    const id = item.stream_id || item.series_id;
    const found = appProgress.find(p => (p.stream_id == id || p.series_id == id));
    return found ? found.savedTime : 0;
}

// دالة لحذف التقدم (عند انتهاء الفيديو)
function removeProgress(item) {
    const id = item.stream_id || item.series_id;
    appProgress = appProgress.filter(p => (p.stream_id != id && p.series_id != id));
    setLocalStorage('iptv_progress', appProgress);
}





                        function renderAccountsList() {
    loadAccounts();
    const list = document.getElementById('accounts-list');
    list.innerHTML = '';

    if (accounts.length === 0) {
        list.innerHTML = `
            <div class="flex flex-col items-center justify-center py-10 text-gray-500 opacity-60">
                <i class="fas fa-inbox text-5xl mb-3"></i>
                <p>لا توجد حسابات محفوظة</p>
            </div>`;
        return;
    }

    accounts.forEach(acc => {
        const isActive = currentAccountId === acc.id;
        
        // تحديد أول حرف للاسم
        const firstLetter = acc.name ? acc.name.charAt(0).toUpperCase() : '?';

        const el = document.createElement('div');
        
        // تصميم الكارت (مطابق للصورة)
        el.className = `group relative rounded-2xl p-3 border transition-all duration-300 flex flex-col 
            ${isActive 
                ? 'bg-[#2a1b42] border-[#7158e2] shadow-[0_4px_15px_rgba(113,88,226,0.2)]' 
                : 'bg-[#1e142b] border-white/5 hover:border-white/10 hover:bg-[#251b36]'}`;
        
        el.innerHTML = `
            <div class="flex items-center justify-between w-full gap-3">
                
                <div class="flex items-center gap-3 flex-1 min-w-0 cursor-pointer" onclick="loginWithAccount('${acc.id}')">
                    
                    <div class="w-12 h-12 rounded-full shrink-0 flex items-center justify-center text-lg font-bold shadow-md
                        ${isActive ? 'bg-[#7158e2] text-white' : 'bg-[#352b47] text-gray-400 group-hover:text-white transition'}">
                        ${firstLetter}
                    </div>

                    <div class="flex flex-col min-w-0">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-white text-base truncate leading-tight">${acc.name}</span>
                            ${isActive ? '<span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.8)]"></span>' : ''}
                        </div>
                        <span class="text-[11px] text-gray-500 truncate font-mono mt-0.5 dir-ltr text-right">${acc.host}</span>
                        ${isActive ? '<span class="text-[10px] text-green-400">متصل الآن</span>' : ''}
                    </div>
                </div>

                <div class="flex items-center gap-2 shrink-0">
                    <button onclick="toggleCredsVisibility(this)" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-[#7158e2] hover:text-white text-gray-400 border border-white/5 transition flex items-center justify-center shadow-sm">
                        <i class="fas fa-eye"></i>
                    </button>
                    
                    <button onclick="deleteAccount('${acc.id}')" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-red-500 hover:text-white text-gray-400 border border-white/5 transition flex items-center justify-center shadow-sm">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>

            <div class="creds-box hidden mt-3 bg-[#130a1f] border border-white/5 p-3 rounded-xl shadow-inner text-sm animate-fade-in relative overflow-hidden">
                <div class="absolute top-0 right-0 w-1 h-full bg-[#7158e2]"></div>
                <div class="grid grid-cols-1 gap-2">
                    <div class="flex justify-between items-center border-b border-white/5 pb-2">
                        <span class="text-gray-500 text-xs"><i class="fas fa-user ml-1"></i> المستخدم:</span> 
                        <span class="text-white select-all font-mono dir-ltr text-xs">${acc.user}</span>
                    </div>
                    <div class="flex justify-between items-center pt-1">
                        <span class="text-gray-500 text-xs"><i class="fas fa-key ml-1"></i> الباسورد:</span> 
                        <span class="text-white select-all font-mono dir-ltr text-xs">${acc.pass}</span>
                    </div>
                </div>
            </div>
        `;
        list.appendChild(el);
    });
}

        
        // تحديث دالة الإظهار لتتوافق مع الكود الجديد
        window.toggleCredsVisibility = (btn) => {
            // الوصول للعنصر الأب (الكارت) ثم البحث عن الصندوق داخله
            const card = btn.closest('.group');
            const box = card.querySelector('.creds-box');
            
            if (box.classList.contains('hidden')) {
                box.classList.remove('hidden');
                btn.classList.add('bg-blue-500', 'text-white'); // تلوين الزر عند التفعيل
            } else {
                box.classList.add('hidden');
                btn.classList.remove('bg-blue-500', 'text-white');
            }
        };

        window.renderAccountsList = renderAccountsList;


        // دوال مساعدة للحسابات (يجب أن تكون Global لتستدعيها الـ onclick في HTML)
        window.loginWithAccount = (id) => {
            const acc = accounts.find(a => a.id === id);
            if(acc) {
                document.getElementById('accounts-modal').classList.add('hidden');
                // تعبئة الحقول والدخول
                document.getElementById('host').value = acc.host;
                document.getElementById('username').value = acc.user;
                document.getElementById('password').value = acc.pass;
                document.getElementById('account-name').value = acc.name;
                
                handleLogin(acc.host, acc.user, acc.pass, true);
            }
        };

        window.deleteAccount = (id) => {
            if(confirm('هل أنت متأكد من حذف هذا الحساب؟ سيتم حذف المفضلة والسجل الخاص به أيضاً.')) {
                accounts = accounts.filter(a => a.id !== id);
                saveAccounts();
                
                // تنظيف بيانات الحساب من الذاكرة
                localStorage.removeItem(`acc_${id}_favorites`);
                localStorage.removeItem(`acc_${id}_history`);
                localStorage.removeItem(`acc_${id}_progress`);
                
                if(currentAccountId === id) {
                    // إذا حذفنا الحساب المفتوح حالياً، نخرج منه
                    document.getElementById('logout-button').click();
                } else {
                    renderAccountsList();
                }
            }
        };

        window.toggleCredsVisibility = (btn, user, pass) => {
            // إظهار/إخفاء الصندوق الموجود داخل العنصر الأب
            const parent = btn.closest('.group');
            const box = parent.querySelector('.creds-box');
            box.classList.toggle('hidden');
        };










                      // --- الاستعادة التلقائية للحساب الأخير ---
        loadAccounts();
        const lastActiveId = localStorage.getItem('iptv_last_active_id');
        
        if (lastActiveId) {
            const acc = accounts.find(a => a.id === lastActiveId);
            if (acc) {
                // تعبئة البيانات والدخول
                if(document.getElementById('host')) document.getElementById('host').value = acc.host;
                if(document.getElementById('username')) document.getElementById('username').value = acc.user;
                if(document.getElementById('password')) document.getElementById('password').value = acc.pass;
                
                // الحل هنا: التحقق من وجود الحقل قبل تعبئته لمنع الخطأ
                const accNameInput = document.getElementById('account-name');
                if (accNameInput) {
                    accNameInput.value = acc.name;
                }

                if(document.getElementById('remember-me')) document.getElementById('remember-me').checked = true;

                handleLogin(acc.host, acc.user, acc.pass, true);
            }
        }





   






    }); // End DOMContentLoaded
    </script>


<div id="accounts-modal" class="hidden fixed inset-0 z-[300] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in">
    <div class="bg-[#120822] border border-[#7158e2]/30 w-full max-w-md rounded-[2rem] overflow-hidden shadow-[0_0_50px_rgba(113,88,226,0.15)] relative flex flex-col max-h-[85vh]">
        
        <div class="p-5 bg-gradient-to-r from-[#2c1355] to-[#1a0b2e] border-b border-white/5 flex justify-between items-center relative overflow-hidden shrink-0">
            <div class="absolute -top-10 -right-10 w-24 h-24 bg-[#7158e2]/20 rounded-full blur-xl"></div>
            
            <h3 class="text-xl font-bold text-white relative z-10 flex items-center gap-2">
                <i class="fas fa-users-cog text-[#7158e2]"></i> الحسابات المحفوظة
            </h3>
            <button id="close-accounts-btn" class="w-9 h-9 rounded-full bg-white/5 hover:bg-white/20 text-gray-300 hover:text-white flex items-center justify-center transition z-10">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <div id="accounts-list" class="p-4 overflow-y-auto space-y-3 scroller-smooth flex-1 min-h-0 relative z-10 bg-[#120822]">
            </div>

        <div class="p-5 bg-[#0f041c] border-t border-white/5 shrink-0 z-20 space-y-3">
            
            <button id="add-new-account-btn" class="w-full py-3.5 rounded-2xl border border-dashed border-[#7158e2]/40 bg-[#7158e2]/5 text-[#a29bfe] hover:bg-[#7158e2]/10 hover:border-[#7158e2] hover:text-white transition flex items-center justify-center gap-2 group">
                <i class="fas fa-plus group-hover:rotate-90 transition-transform duration-300"></i>
                <span class="font-bold">إضافة حساب جديد</span>
            </button>
            
            <div class="grid grid-cols-2 gap-3">
                <button onclick="document.getElementById('backup-upload').click()" class="py-3 rounded-xl bg-[#00b894]/10 hover:bg-[#00b894]/20 text-[#00b894] border border-[#00b894]/20 transition flex items-center justify-center gap-2 text-sm font-bold">
                    <i class="fas fa-file-import"></i> استعادة
                </button>
                <button onclick="exportBackup()" class="py-3 rounded-xl bg-[#0984e3]/10 hover:bg-[#0984e3]/20 text-[#0984e3] border border-[#0984e3]/20 transition flex items-center justify-center gap-2 text-sm font-bold">
                    <i class="fas fa-file-export"></i> تصدير
                </button>
            </div>
            
            <input type="file" id="backup-upload" accept=".json" class="hidden" onchange="importBackup(this)">
        </div>
    </div>
</div>


<script>
    // هذا الجزء الخاص بحقن الأزرار يتم تنفيذه بعد تحميل الصفحة
    document.addEventListener("DOMContentLoaded", () => {
        const loginContainer = document.querySelector('#login-view .space-y-4');
        const loginBtn = document.getElementById('login-button');
        
        // 1. إضافة حقل اسم الحساب
        const nameDiv = document.createElement('div');
        nameDiv.className = "relative mb-2";
        nameDiv.innerHTML = `
            <i class="fas fa-tag absolute right-4 top-4 text-gray-400"></i>
            <input type="text" id="account-name" placeholder="اسم مستعار للحساب (مثلاً: سيرفر المنزل)" class="glass-input w-full p-3 pr-10 rounded-xl text-left text-sm" dir="rtl">
        `;
        if(loginContainer) loginContainer.insertBefore(nameDiv, loginContainer.firstChild);

        // 2. إضافة زر "إدارة الحسابات"
        const manageBtn = document.createElement('button');
        manageBtn.id = 'open-accounts-btn';
        manageBtn.className = "w-full py-3 mt-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-gray-300 text-sm transition flex items-center justify-center gap-2";
        manageBtn.innerHTML = '<i class="fas fa-users"></i> حساباتي المحفوظة';
        
        if(loginBtn) loginBtn.parentNode.insertBefore(manageBtn, loginBtn.nextSibling);
        
        // ربط الأحداث
        if(document.getElementById('open-accounts-btn')) {
            document.getElementById('open-accounts-btn').onclick = () => {
                if(window.renderAccountsList) window.renderAccountsList();
                document.getElementById('accounts-modal').classList.remove('hidden');
            };
        }
        if(document.getElementById('close-accounts-btn')) {
            document.getElementById('close-accounts-btn').onclick = () => {
                document.getElementById('accounts-modal').classList.add('hidden');
            };
        }
        
        // زر إضافة حساب جديد
        if(document.getElementById('add-new-account-btn')) {
            document.getElementById('add-new-account-btn').onclick = () => {
                document.getElementById('accounts-modal').classList.add('hidden');
                
                if(document.getElementById('host')) document.getElementById('host').value = '';
                if(document.getElementById('username')) document.getElementById('username').value = '';
                if(document.getElementById('password')) document.getElementById('password').value = '';
                if(document.getElementById('account-name')) document.getElementById('account-name').value = '';
                
                document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
                document.getElementById('login-view').classList.remove('hidden');
            };
        }

        // PWA Install Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('install-btn');
            if(installBtn) {
                installBtn.style.display = 'block';
                installBtn.onclick = async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            installBtn.style.display = 'none';
                        }
                        deferredPrompt = null;
                    }
                };
            }
        });
    });

    // =================================================================
    // هام جداً: الدوال هنا خارج الـ eventListener لتراها أزرار HTML
    // =================================================================

    /**
     * دالة تصدير النسخة الاحتياطية
     */
    function exportBackup() {
        try {
            const accountsList = localStorage.getItem('iptv_accounts_list');
            if (!accountsList) {
                alert('لا توجد حسابات لتصديرها!');
                return;
            }

            const accounts = JSON.parse(accountsList);
            const backupData = {
                version: '1.0',
                date: new Date().toISOString(),
                accounts: accounts,
                details: {} 
            };

            accounts.forEach(acc => {
                const id = acc.id;
                // التأكد من وجود البيانات قبل إضافتها لتجنب null
                const favs = localStorage.getItem(`acc_${id}_favorites`);
                const hist = localStorage.getItem(`acc_${id}_history`);
                const prog = localStorage.getItem(`acc_${id}_progress`);
                
                if(favs) backupData.details[`acc_${id}_favorites`] = favs;
                if(hist) backupData.details[`acc_${id}_history`] = hist;
                if(prog) backupData.details[`acc_${id}_progress`] = prog;
            });

            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            const fileName = `IPTV_Backup_${new Date().toISOString().slice(0,10)}.json`;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

        } catch (e) {
            console.error('Export Error:', e);
            alert('حدث خطأ أثناء التصدير');
        }
    }

    /**
     * دالة استعادة النسخة الاحتياطية
     */
    function importBackup(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const content = e.target.result;
                const data = JSON.parse(content);

                if (!data.accounts || !Array.isArray(data.accounts)) {
                    alert('الملف غير صالح أو تالف.');
                    return;
                }

                if (!confirm(`سيتم استعادة ${data.accounts.length} حسابات. هل تريد المتابعة؟ (سيتم دمج البيانات مع الحالية)`)) {
                    inputElement.value = ''; 
                    return;
                }

                let currentAccounts = JSON.parse(localStorage.getItem('iptv_accounts_list') || "[]");
                
                data.accounts.forEach(newAcc => {
                    const exists = currentAccounts.find(a => a.id === newAcc.id);
                    if (!exists) {
                        currentAccounts.push(newAcc);
                    } else {
                        Object.assign(exists, newAcc);
                    }
                });
                
                localStorage.setItem('iptv_accounts_list', JSON.stringify(currentAccounts));

                if (data.details) {
                    Object.keys(data.details).forEach(key => {
                        const value = data.details[key];
                        if (value) {
                            localStorage.setItem(key, value);
                        }
                    });
                }

                alert('تمت استعادة البيانات بنجاح! سيتم إعادة تحميل التطبيق.');
                window.location.reload();

            } catch (err) {
                console.error('Import Error:', err);
                alert('حدث خطأ أثناء قراءة ملف النسخة الاحتياطية.');
            }
        };

        reader.readAsText(file);
    }
</script>
<script>

    // ==============================================================
    // الحل النهائي: مستمع عام للنقرات (يعمل مع العناصر الديناميكية)
    // ==============================================================
    document.addEventListener('deviceready', () => {

    document.addEventListener('click', (e) => {
        const btn = e.target.closest('#btn-open-external');
        if (!btn) return;

        e.preventDefault();

        if (!currentStreamInfo || !currentStreamInfo.url) {
            alert('لا يوجد رابط فيديو متاح');
            return;
        }

        let streamUrl = currentStreamInfo.url.trim();
        if (streamUrl.startsWith('//')) {
            streamUrl = 'https:' + streamUrl;
        }

        // 🔥 الحل الذهبي: افتح الرابط الحقيقي ودع النظام يختار المشغل
        if (window.cordova && cordova.InAppBrowser) {
            cordova.InAppBrowser.open(
                streamUrl,
                '_system',
                'location=no'
            );
        } else {
            window.open(streamUrl, '_blank');
        }
    });

});

    // 1. تسجيل الـ Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker Registered! Scope:', reg.scope))
                .catch(err => console.error('Service Worker Failed:', err));
        });
    }

    // 2. منطق زر التثبيت
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');

    // هذا الحدث لا يعمل إلا إذا كان ملف manifest.json سليم 100%
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); // منع النافذة التلقائية
        deferredPrompt = e; // حفظ الحدث
        
        // إظهار الزر (إزالة كلاس hidden)
        if(installBtn) {
            installBtn.classList.remove('hidden');
            installBtn.style.display = 'block'; // تأكيد الإظهار
        }
        console.log('App is ready to install!');
    });

    if(installBtn) {
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                if (outcome === 'accepted') {
                    installBtn.style.display = 'none'; // إخفاء الزر بعد الموافقة
                }
                deferredPrompt = null;
            }
        });
    }
</script>


</body>
</html>
